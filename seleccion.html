<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selección de Candidatos - Gestión Candidatos</title>
</head>

<body>

    <div class="container-xl my-5">
        <div class="row mb-5 align-items-center page-header">
            <div class="col-md-8">
                <h2 class="fw-bold mb-1"
                    style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    <i class="fas fa-users-cog me-2 text-primary"></i>Selección de Candidatos
                </h2>
                <p class="text-muted mb-0">Compare, evalúe y seleccione al mejor candidato para cada vacante.</p>
            </div>
            <div class="col-md-4 text-end">
                <!-- Actions if any -->
            </div>
        </div>

        <!-- Filters Section -->
        <div class="card shadow-sm mb-4 bg-white border-0">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                    <h6 class="fw-bold text-muted mb-0 text-uppercase small letter-spacing-1"><i
                            class="fas fa-filter me-2"></i>Filtros de Búsqueda</h6>
                    <button class="btn btn-sm btn-light text-muted" onclick="clearFilters()">
                        <i class="fas fa-undo me-1"></i> Reiniciar
                    </button>
                </div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label small text-muted fw-bold">Buscar Texto</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light border-end-0"><i
                                    class="fas fa-search text-muted"></i></span>
                            <input type="text" id="filterSearch" class="form-control border-start-0 ps-0"
                                placeholder="Nombre, detalle...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-muted fw-bold">Cargo</label>
                        <select id="filterCargo" class="form-select form-select-sm"></select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-muted fw-bold">Estado Postulación</label>
                        <select id="filterEstado" class="form-select form-select-sm fw-bold">
                            <option value="">Todos</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Revisión CV">Revisión CV</option>
                            <option value="Entrevista">Entrevista</option>
                            <option value="Finalista">Finalista</option>
                            <option value="Seleccionado">Seleccionado</option>
                            <option value="Rechazado">Rechazado</option>
                        </select>
                    </div>


                    <!-- Advanced Filters -->
                    <div class="col-md-4">
                        <label class="form-label small text-muted fw-bold">Nivel Cargo</label>
                        <select id="filterNivel" class="form-select form-select-sm"></select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-muted fw-bold">Dependencia (Jefatura)</label>
                        <select id="filterDepende" class="form-select form-select-sm"></select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-muted fw-bold">Tipo Contrato</label>
                        <select id="filterTipo" class="form-select form-select-sm"></select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsContainer">
            <div class="text-center py-5">
                <div class="mb-3"><i class="fas fa-clipboard-list fa-3x text-muted opacity-25"></i></div>
                <h5 class="text-muted fw-normal">Cargando datos...</h5>
            </div>
        </div>

    </div>

    <!-- Detailed Info Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold text-dark">Información de Candidato</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4 bg-white" id="detailContent">
                    <!-- Content injected via JS -->
                </div>
                <div class="modal-footer bg-light border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Viewer Modal (Correct Structure) -->
    <div id="pdfViewerModal" class="pdf-viewer-modal">
        <div class="pdf-viewer-header">
            <div class="d-flex align-items-center">
                <i class="fas fa-file-pdf text-danger fs-4 me-3"></i>
                <div>
                    <h5 class="fw-bold mb-0 text-dark" id="viewerDocName">Documento</h5>
                    <small class="text-muted">Vista previa</small>
                </div>
            </div>
            <button class="pdf-viewer-close-btn" onclick="closePdfViewer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="pdf-viewer-body">
            <iframe id="pdfFrame" class="pdf-viewer-iframe"></iframe>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        document.addEventListener('libsLoaded', initApp);
        if (window.jQuery && $.fn && $.fn.DataTable) initApp();

        let allRevisiones = [];
        let currentBlobUrl = null;
        let currentDocId = null;
        let currentDocName = '';

        function initApp() {
            if (!isAuthenticated()) { window.location.href = "index.html"; return; }
            renderLayout('seleccion');

            loadData();
            initEventListeners();
        }

        async function loadData(preserveFilters = false) {
            // Add timestamp to prevent caching
            const res = await fetchAPI(`/revisiones?t=${new Date().getTime()}`);
            if (res) {
                allRevisiones = await res.json();
                populateFilters(allRevisiones, preserveFilters);
                filterAndDisplay(); // Show all data immediately
            }
        }

        function initEventListeners() {
            // Multidirectional Filters
            $('#filterCargo').on('change', function () {
                updateAllFilters('cargo');
                filterAndDisplay();
            });
            $('#filterNivel').on('change', function () {
                updateAllFilters('nivel');
                filterAndDisplay();
            });
            $('#filterDepende').on('change', function () {
                updateAllFilters('depende');
                filterAndDisplay();
            });
            $('#filterTipo').on('change', function () {
                updateAllFilters('tipo');
                filterAndDisplay();
            });
            $('#filterEstado').on('change', filterAndDisplay);
            $('#filterSearch').on('keyup', filterAndDisplay);
        }

        function populateFilters(data, preserve = false) {
            // Get current values if we need to preserve them
            const currentCargo = preserve ? $('#filterCargo').val() : '';
            const currentNivel = preserve ? $('#filterNivel').val() : '';
            const currentDepende = preserve ? $('#filterDepende').val() : '';
            const currentTipo = preserve ? $('#filterTipo').val() : '';

            // Reset logic: populate main filters based on FULL data first
            const cargos = [...new Set(data.map(d => d.cargo_detalle).filter(Boolean))].sort();
            const niveles = [...new Set(data.map(d => d.cargo_nivel).filter(Boolean))].sort();

            fillSelect('#filterCargo', cargos, currentCargo);
            fillSelect('#filterNivel', niveles, currentNivel);

            // If we are preserving, we might need to set the others too before triggering update
            if (preserve) {
                // We rely on updateAllFilters to fix the dependent dropdowns (Depende, Tipo)
                // based on the preserved Cargo/Nivel
            }

            updateAllFilters('init');
        }

        function updateAllFilters(changedFilter) {
            const currentFilters = {
                cargo: $('#filterCargo').val(),
                nivel: $('#filterNivel').val(),
                depende: $('#filterDepende').val(),
                tipo: $('#filterTipo').val()
            };

            // Helper to get options based on other filters
            const getOptions = (excludeField) => {
                return allRevisiones.filter(d => {
                    if (excludeField !== 'cargo' && currentFilters.cargo && d.cargo_detalle !== currentFilters.cargo) return false;
                    if (excludeField !== 'nivel' && currentFilters.nivel && d.cargo_nivel !== currentFilters.nivel) return false;
                    if (excludeField !== 'depende' && currentFilters.depende && d.cargo_depende !== currentFilters.depende) return false;
                    if (excludeField !== 'tipo' && currentFilters.tipo && d.cargo_tipo !== currentFilters.tipo) return false;
                    return true;
                });
            };

            // Update Cargo options (based on Nivel, Depende, Tipo)
            if (changedFilter !== 'cargo') {
                const filtered = getOptions('cargo');
                const cargos = [...new Set(filtered.map(d => d.cargo_detalle).filter(Boolean))].sort();
                fillSelect('#filterCargo', cargos, currentFilters.cargo);
            }

            // Update Nivel options (based on Cargo, Depende, Tipo)
            if (changedFilter !== 'nivel') {
                const filtered = getOptions('nivel');
                const niveles = [...new Set(filtered.map(d => d.cargo_nivel).filter(Boolean))].sort();
                fillSelect('#filterNivel', niveles, currentFilters.nivel);
            }

            // Update Depende options (based on Cargo, Nivel, Tipo)
            if (changedFilter !== 'depende') {
                const filtered = getOptions('depende');
                const dependes = [...new Set(filtered.map(d => d.cargo_depende).filter(Boolean))].sort();
                fillSelect('#filterDepende', dependes, currentFilters.depende);
            }

            // Update Tipo options (based on Cargo, Nivel, Depende)
            if (changedFilter !== 'tipo') {
                const filtered = getOptions('tipo');
                const tipos = [...new Set(filtered.map(d => d.cargo_tipo).filter(Boolean))].sort();
                fillSelect('#filterTipo', tipos, currentFilters.tipo);
            }
        }

        function fillSelect(selector, values, currentSelection) {
            const el = $(selector);
            const current = currentSelection !== undefined ? currentSelection : el.val();
            if (selector !== '#filterEstado') {
                el.empty().append('<option value="">Todos</option>');
                values.forEach(v => el.append(new Option(v, v)));
            }
            if (current && values.includes(current)) el.val(current);
            else if (current && selector !== '#filterEstado') el.val('');
        }

        function clearFilters() {
            $('#filterSearch').val('');
            $('#filterEstado').val('');
            $('#filterCargo').val('').trigger('change');
            filterAndDisplay();
        }

        function filterAndDisplay() {
            const search = $('#filterSearch').val().toLowerCase();
            const cargo = $('#filterCargo').val();
            const nivel = $('#filterNivel').val();
            const depende = $('#filterDepende').val();
            const tipo = $('#filterTipo').val();
            const estado = $('#filterEstado').val();

            let filtered = allRevisiones.filter(d => {
                const matchesSearch = !search ||
                    (d.nombres && d.nombres.toLowerCase().includes(search)) ||
                    (d.apellidopaterno && d.apellidopaterno.toLowerCase().includes(search)) ||
                    (d.rut && d.rut.toLowerCase().includes(search));

                const matchesCargo = !cargo || d.cargo_detalle == cargo;
                const matchesNivel = !nivel || d.cargo_nivel == nivel;
                const matchesDepende = !depende || d.cargo_depende == depende;
                const matchesTipo = !tipo || d.cargo_tipo == tipo;
                const matchesEstado = !estado || d.estado == estado;

                return matchesSearch && matchesCargo && matchesNivel && matchesDepende && matchesTipo && matchesEstado;
            });

            displayCandidates(filtered);
        }

        function displayCandidates(candidates) {
            const container = $('#resultsContainer');

            if (candidates.length === 0) {
                container.html(`
                    <div class="alert alert-light border shadow-sm text-center py-5">
                         <div class="mb-3"><i class="fas fa-search fa-3x text-muted opacity-50"></i></div>
                        <h5>No se encontraron candidatos</h5>
                        <p class="text-muted small">Intente ajustar los filtros para ver resultados.</p>
                    </div>
                `);
                return;
            }

            // A. Pre-calculate selected candidates globally
            const globallySelectedMap = {};
            allRevisiones.forEach(r => {
                if (r.estado === 'Seleccionado') {
                    const key = r.rut || `${r.nombres}|${r.apellidopaterno}`;
                    globallySelectedMap[key] = `${r.cargo_tipo || ''} - ${r.cargo_detalle || ''} - ${r.cargo_nivel || ''}`;
                }
            });

            // Group by cargo
            const byCargo = {};
            candidates.forEach(c => {
                const key = c.cargo_detalle || 'Sin cargo';
                if (!byCargo[key]) byCargo[key] = [];
                byCargo[key].push(c);
            });

            let html = '';
            Object.keys(byCargo).forEach(cargoName => {
                const groupCandidates = byCargo[cargoName];
                const firstCandidate = groupCandidates[0];

                html += `
                    <div class="card mb-5 border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom py-3 d-flex align-items-center justify-content-between">
                            <div>
                                <h5 class="fw-bold text-dark mb-1">
                                    <i class="fas fa-briefcase text-primary me-2"></i>${cargoName}
                                </h5>
                                <div class="d-flex gap-2 align-items-center">
                                     <span class="badge bg-light text-dark border">${firstCandidate.cargo_nivel || '-'}</span>
                                     <span class="small text-muted">${firstCandidate.cargo_tipo || ''}</span>
                                     <span class="small text-muted">•</span>
                                     <span class="small text-muted">${firstCandidate.cargo_depende || ''}</span>
                                </div>
                            </div>
                            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill">${groupCandidates.length} Postulantes</span>
                        </div>
                        <div class="card-body bg-light bg-opacity-25 pb-4">
                            <div class="row g-4">
                `;

                // Sort candidates: Seleccionado first, then Priority
                groupCandidates.sort((a, b) => {
                    if (a.estado === 'Seleccionado') return -1;
                    if (b.estado === 'Seleccionado') return 1;
                    const map = { 'Alta': 3, 'Media': 2, 'Baja': 1 };
                    return (map[b.prioridad] || 0) - (map[a.prioridad] || 0);
                });

                groupCandidates.forEach(c => {
                    const statusClass = getStatusBadgeClass(c.estado);
                    const personKey = c.rut || `${c.nombres}|${c.apellidopaterno}`;
                    const selectedElsewhereCargo = globallySelectedMap[personKey];
                    const isSelectedElsewhere = selectedElsewhereCargo && c.estado !== 'Seleccionado';

                    // Card styling based on status
                    let cardClass = "border-0 shadow-sm card-hover";
                    let headerClass = "bg-white border-bottom-0";

                    if (c.estado === 'Seleccionado') {
                        cardClass = "border-2 border-success shadow-md";
                        headerClass = "bg-success bg-opacity-10 border-bottom-0";
                    }

                    // Initials
                    const names = (c.nombres || "").split(' ');
                    const initials = (names[0][0] + (names[1] ? names[1][0] : '')).toUpperCase();

                    html += `
                        <div class="col-md-6 col-xl-4">
                            <div class="card h-100 ${cardClass} overflow-hidden position-relative">
                                ${isSelectedElsewhere ? `
                                    <div class="position-absolute top-0 start-0 w-100 bg-warning text-dark text-center small fw-bold py-1" style="z-index:10;">
                                        <i class="fas fa-exclamation-circle me-1"></i> Seleccionado en otro cargo
                                    </div>
                                    <div style="height: 20px;"></div>
                                ` : ''}
                                
                                <div class="card-body position-relative">
                                     <div class="position-absolute top-0 end-0 p-3">
                                         <span class="badge ${statusClass}">${c.estado}</span>
                                     </div>
                                     
                                    <div class="d-flex align-items-center mb-4 pt-1">
                                        <div class="rounded-circle bg-gradient bg-primary text-white d-flex align-items-center justify-content-center shadow-sm me-3 fw-bold" 
                                             style="width: 56px; height: 56px; font-size: 1.2rem;">
                                            ${initials}
                                        </div>
                                        <div>
                                            <h6 class="fw-bold text-dark mb-0 fs-5">${c.nombres} ${c.apellidopaterno}</h6>
                                            <small class="text-muted">${c.rut || '-'}</small>
                                        </div>
                                    </div>

                                    <div class="row g-2 small mb-3">
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded text-center h-100 border">
                                                <div class="text-muted x-small text-uppercase fw-bold">Prioridad</div>
                                                <div class="fw-bold text-dark">${c.prioridad || '-'}</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded text-center h-100 border">
                                                <div class="text-muted x-small text-uppercase fw-bold">Fit Político</div>
                                                <div class="fw-bold text-dark">${c.fit_politico || '-'}</div>
                                            </div>
                                        </div>
                                    </div>

                                    ${isSelectedElsewhere ? `
                                        <div class="alert alert-warning p-2 small mb-3 d-flex align-items-start gap-2">
                                            <i class="fas fa-info-circle mt-1"></i>
                                            <div class="lh-sm"><strong>Ocupado en:</strong><br>${selectedElsewhereCargo}</div>
                                        </div>
                                    ` : ''}

                                    ${c.comentarios ? `
                                        <div class="mb-3 border-start border-3 border-primary ps-3 py-1 bg-light rounded-end">
                                            <small class="text-muted d-block text-truncate fst-italic">"${c.comentarios}"</small>
                                        </div>
                                    ` : ''}

                                    <div class="d-grid gap-2 mt-auto">
                                        <div class="btn-group shadow-sm">
                                            <button class="btn btn-sm btn-light border flex-grow-1 text-muted" onclick="showDetailModal(${c.idrevision})">
                                                <i class="fas fa-info-circle"></i> Detalle
                                            </button>
                                            <button class="btn btn-sm btn-light border flex-grow-1 text-muted" onclick="viewCandidateDocs(${c.idpostulacion})">
                                                <i class="fas fa-file-pdf"></i> CV
                                            </button>
                                        </div>

                                        ${c.estado !== 'Seleccionado' ? `
                                            <button class="btn btn-sm ${isSelectedElsewhere ? 'btn-outline-warning text-dark' : 'btn-primary'}" 
                                                onclick="selectCandidate(${c.idrevision}, '${cargoName}')">
                                                <i class="fas fa-check-circle me-1"></i> ${isSelectedElsewhere ? 'Forzar Selección' : 'Seleccionar Candidato'}
                                            </button>
                                        ` : `
                                             <button class="btn btn-sm btn-success disabled opacity-100">
                                                <i class="fas fa-star me-1"></i> Seleccionado Actual
                                            </button>
                                        `}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                            </div>
                        </div>
                    </div>
                `;
            });

            container.html(html);
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 'Pendiente': return 'bg-warning text-dark';
                case 'Revisión CV': return 'bg-info text-dark';
                case 'Preseleccionado': return 'bg-primary';
                case 'Seleccionado': return 'bg-success';
                case 'Finalizado': return 'bg-dark';
                case 'Rechazado': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        async function viewCandidateDocs(postulacionId) {
            // Get persona ID from postulacion
            const postRes = await fetchAPI(`/postulaciones`);
            if (!postRes) return;

            const postulaciones = await postRes.json();
            const postulacion = postulaciones.find(p => p.idpostulacion == postulacionId);

            if (!postulacion) {
                showToast("No se encontró la postulación", "error");
                return;
            }

            // Get documents for this persona
            const docsRes = await fetchAPI(`/personas/${postulacion.idpersona}/documentos`);
            if (!docsRes) {
                showToast("Error al cargar documentos", "error");
                return;
            }

            const docs = await docsRes.json();
            if (docs.length === 0) {
                showToast("No hay documentos disponibles", "warning");
                return;
            }

            // Open the first document (CV)
            const cvDoc = docs.find(d => d.nombre && d.nombre.toLowerCase().includes('cv')) || docs[0];
            openPdfViewer(cvDoc.documento_id, cvDoc.nombre || cvDoc.archivo_nombre);
        }

        async function showDetailModal(revisionId) {
            const revision = allRevisiones.find(r => r.idrevision == revisionId);
            if (!revision) return;

            // Get full persona data
            const postRes = await fetchAPI('/postulaciones');
            if (!postRes) return;

            const postulaciones = await postRes.json();
            const postulacion = postulaciones.find(p => p.idpostulacion == revision.idpostulacion);

            if (!postulacion) return;

            const personaRes = await fetchAPI(`/personas/${postulacion.idpersona}`);
            if (!personaRes) return;

            const persona = await personaRes.json();

            const html = `
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2"><i class="fas fa-user me-2"></i>Información Personal</h6>
                    </div>
                    <div class="col-md-4"><label class="fw-bold small text-muted">RUT</label><p>${persona.rut}</p></div>
                    <div class="col-md-8"><label class="fw-bold small text-muted">Nombre Completo</label><p>${persona.nombres} ${persona.apellidopaterno} ${persona.apellidomaterno || ''}</p></div>
                    
                    <div class="col-md-4"><label class="fw-bold small text-muted">Fecha Nacimiento</label><p>${persona.fechanacimiento ? new Date(persona.fechanacimiento).toLocaleDateString() : '-'}</p></div>
                    <div class="col-md-4"><label class="fw-bold small text-muted">Género</label><p>${persona.genero || '-'}</p></div>
                    <div class="col-md-4"><label class="fw-bold small text-muted">Nacionalidad</label><p>${persona.nacionalidad || '-'}</p></div>
                    
                    <div class="col-md-6"><label class="fw-bold small text-muted">Correo</label><p>${persona.correoelectronico || '-'}</p></div>
                    <div class="col-md-6"><label class="fw-bold small text-muted">Teléfono</label><p>${persona.telefonocelular || '-'}</p></div>
                    
                    <div class="col-md-4"><label class="fw-bold small text-muted">Región</label><p>${persona.regionresidencia || '-'}</p></div>
                    <div class="col-md-4"><label class="fw-bold small text-muted">Profesión</label><p>${persona.profesion || '-'}</p></div>
                    <div class="col-md-4"><label class="fw-bold small text-muted">Grado Académico</label><p>${persona.gradoacademico || '-'}</p></div>
                    
                    <div class="col-md-12"><label class="fw-bold small text-muted">Partido Político</label><p>${persona.partidopolitico || '-'}</p></div>
                    
                    <div class="col-12"><label class="fw-bold small text-muted">Antecedentes</label><p class="bg-light p-2 rounded">${persona.antecedentes || 'Sin antecedentes'}</p></div>
                    <div class="col-12"><label class="fw-bold small text-muted">Referencias</label><p class="bg-light p-2 rounded">${persona.referencias || 'Sin referencias'}</p></div>
                    <div class="col-12"><label class="fw-bold small text-muted">Observaciones</label><p class="bg-light p-2 rounded">${persona.observaciones || 'Sin observaciones'}</p></div>
                    
                    <div class="col-12">
                        <h6 class="text-success border-bottom pb-2 mt-3"><i class="fas fa-clipboard-check me-2"></i>Información de Revisión</h6>
                    </div>
                    <div class="col-md-4"><label class="fw-bold small text-muted">Estado</label><p><span class="badge ${getStatusBadgeClass(revision.estado)}">${revision.estado}</span></p></div>
                    <div class="col-md-4"><label class="fw-bold small text-muted">Prioridad</label><p>${revision.prioridad || '-'}</p></div>
                    <div class="col-md-4"><label class="fw-bold small text-muted">Fit Político</label><p>${revision.fit_politico || '-'}</p></div>
                    
                    <div class="col-md-6"><label class="fw-bold small text-muted">Revisión CSIA</label><p>${revision.revisioncsia || 'No'}</p></div>
                    <div class="col-md-6"><label class="fw-bold small text-muted">Fecha Revisión</label><p>${new Date(revision.fecharevision).toLocaleDateString()}</p></div>
                    
                    <div class="col-12"><label class="fw-bold small text-muted">Comentarios</label><p class="bg-light p-2 rounded">${revision.comentarios || 'Sin comentarios'}</p></div>
                    
                    <div class="col-12">
                        <h6 class="text-info border-bottom pb-2 mt-3"><i class="fas fa-briefcase me-2"></i>Cargo</h6>
                    </div>
                    <div class="col-md-12"><label class="fw-bold small text-muted">Cargo</label><p>${revision.cargo_detalle || '-'}</p></div>
                    <div class="col-md-4"><label class="fw-bold small text-muted">Nivel</label><p>${revision.cargo_nivel || '-'}</p></div>
                    <div class="col-md-4"><label class="fw-bold small text-muted">Tipo</label><p>${revision.cargo_tipo || '-'}</p></div>
                    <div class="col-md-4"><label class="fw-bold small text-muted">Depende De</label><p>${revision.cargo_depende || '-'}</p></div>
                </div>
            `;

            $('#detailContent').html(html);
            $('#detailModal').modal('show');
        }

        async function selectCandidate(revisionId, cargoName) {
            // CRITICAL: Refresh data BEFORE checking current state to avoid race conditions/stale data
            await loadData(true);

            if (!confirm("¿Desea seleccionar este candidato para el cargo? Esto cambiará el estado de cualquier otro candidato previamente seleccionado para este cargo.")) return;

            // Find the revision to select (from fresh data)
            const revisionToSelect = allRevisiones.find(r => r.idrevision == revisionId);
            if (!revisionToSelect) return;

            // 1. Validar si la persona YA está seleccionada en OTRO cargo
            const samePersonSelectedElsewhere = allRevisiones.find(r =>
                (r.rut === revisionToSelect.rut || (r.nombres === revisionToSelect.nombres && r.apellidopaterno === revisionToSelect.apellidopaterno)) &&
                r.estado === 'Seleccionado' &&
                r.idrevision != revisionId
            );

            if (samePersonSelectedElsewhere) {
                const confirmMessage = `ADVERTENCIA: Este candidato (${revisionToSelect.nombres} ${revisionToSelect.apellidopaterno}) YA está seleccionado para el cargo:\n"${samePersonSelectedElsewhere.cargo_detalle}"\n\n¿Desea cambiarlo a este nuevo cargo? El cargo anterior quedará vacante.`;
                if (!confirm(confirmMessage)) return;
            }

            // 2. Si estaba seleccionado en otro lado, lo deseleccionamos primero
            if (samePersonSelectedElsewhere) {
                const revertOldRes = await fetchAPI(`/revisiones/${samePersonSelectedElsewhere.idrevision}`, {
                    method: 'PUT',
                    body: JSON.stringify({ estado: 'Preseleccionado' })
                });
                if (!revertOldRes || !revertOldRes.ok) {
                    showToast("Error al revertir la selección anterior del candidato", "error");
                    return;
                }
            }

            // 3. Find if there's already a selected candidate for THIS cargo (to replace them)
            const currentSelectedForThisCargo = allRevisiones.find(r =>
                r.cargo_detalle == cargoName &&
                r.estado === 'Seleccionado' &&
                r.idrevision != revisionId
            );

            // If there's a currently selected candidate for this cargo, revert them
            if (currentSelectedForThisCargo) {
                const revertRes = await fetchAPI(`/revisiones/${currentSelectedForThisCargo.idrevision}`, {
                    method: 'PUT',
                    body: JSON.stringify({ estado: 'Preseleccionado' })
                });

                if (!revertRes || !revertRes.ok) {
                    showToast("Error al actualizar el candidato anterior de este cargo", "error");
                    return;
                }
            }

            // 4. Select the new candidate
            const res = await fetchAPI(`/revisiones/${revisionId}`, {
                method: 'PUT',
                body: JSON.stringify({ estado: 'Seleccionado' })
            });

            if (res && res.ok) {
                let msg = "Candidato seleccionado exitosamente.";
                if (samePersonSelectedElsewhere) msg += " Se movió del cargo anterior.";
                if (currentSelectedForThisCargo) msg += " Se reemplazó al candidato previo de este cargo.";

                showToast(msg);

                // Small delay to ensure DB commit
                setTimeout(async () => {
                    await loadData(true);
                    filterAndDisplay();
                }, 100);
            } else {
                showToast("Error al seleccionar candidato", "error");
            }
        }

        async function openPdfViewer(docId, docName) {
            const modal = document.getElementById('pdfViewerModal');
            const iframe = document.getElementById('pdfFrame');
            const loading = document.getElementById('viewerLoading');
            const nameDisplay = document.getElementById('viewerDocName');

            currentDocId = docId;
            currentDocName = docName;

            nameDisplay.textContent = docName;
            loading.style.display = 'block';
            iframe.style.display = 'none';
            iframe.src = 'about:blank';

            modal.classList.add('active');

            try {
                const token = getToken();
                const response = await fetch(`${API_URL}/documentos/${docId}/view`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al cargar el documento');
                }

                const blob = await response.blob();

                if (currentBlobUrl) {
                    URL.revokeObjectURL(currentBlobUrl);
                }

                currentBlobUrl = URL.createObjectURL(blob);
                iframe.src = currentBlobUrl;

                iframe.onload = () => {
                    loading.style.display = 'none';
                    iframe.style.display = 'block';
                };

            } catch (error) {
                console.error('Error loading PDF:', error);
                loading.innerHTML = '<div class="alert alert-danger">Error al cargar el documento.</div>';
            }
        }

        function closePdfViewer() {
            const modal = document.getElementById('pdfViewerModal');
            const iframe = document.getElementById('pdfFrame');

            modal.classList.remove('active');
            iframe.src = 'about:blank';

            if (currentBlobUrl) {
                URL.revokeObjectURL(currentBlobUrl);
                currentBlobUrl = null;
            }
        }

        async function downloadCurrentDoc() {
            if (!currentDocId) return;

            try {
                const token = getToken();
                const response = await fetch(`${API_URL}/documentos/${currentDocId}/download`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Error downloading');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = currentDocName || 'documento.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showToast("Documento descargado");
            } catch (error) {
                console.error('Download error:', error);
                showToast("Error al descargar", "error");
            }
        }
    </script>
</body>

</html>