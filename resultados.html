<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados - Gestión Candidatos</title>
</head>

<body>

    <div class="container pb-5">
        <!-- Header -->
        <div class="row align-items-center mb-5 page-header">
            <div class="col-md-8">
                <h2 class="fw-bold text-dark mb-1">
                    <i class="fas fa-chart-pie text-success me-2"></i>Resultados de Selección
                </h2>
                <p class="text-muted mb-0">Resumen ejecutivo de candidatos seleccionados por cargo.</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-outline-secondary" onclick="window.print()">
                    <i class="fas fa-print me-2"></i> Imprimir Reporte
                </button>
            </div>
        </div>

        <!-- Metric Cards -->
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card bg-white h-100 border-0 shadow-sm position-relative overflow-hidden">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="text-uppercase fw-bold text-muted small mb-1">Cargos Cubiertos</p>
                                <h2 class="fw-bold text-dark mb-0" id="statCargosCubiertos">-</h2>
                            </div>
                            <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                                <i class="fas fa-check-double text-success fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-white h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="text-uppercase fw-bold text-muted small mb-1">Candidatos Seleccionados</p>
                                <h2 class="fw-bold text-primary mb-0" id="statTotalSeleccionados">-</h2>
                            </div>
                            <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                                <i class="fas fa-users text-primary fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-white h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="text-uppercase fw-bold text-muted small mb-1">Tasa de Éxito</p>
                                <h2 class="fw-bold text-info mb-0" id="statTasaExito">0%</h2>
                            </div>
                            <div class="bg-info bg-opacity-10 p-3 rounded-circle">
                                <i class="fas fa-chart-line text-info fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4 border-0">
            <div class="card-body p-3">
                <div class="row g-2 align-items-center">
                    <div class="col-auto"><i class="fas fa-filter text-muted me-2"></i></div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm border-0 bg-light fw-bold" id="filterNivel">
                            <option value="">Todos los Niveles</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm border-0 bg-light fw-bold" id="filterStatus">
                            <option value="Seleccionado" selected>Solo Seleccionados</option>
                            <option value="">Todos los Estados</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results List -->
        <div id="resultsContainer" class="row g-4">
            <!-- Injected via JS -->
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Analizando resultados...</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="common.js"></script>
    <script>
        document.addEventListener('libsLoaded', initApp);
        // Fallback
        if (typeof isAuthenticated !== 'undefined' && isAuthenticated()) initApp();

        let allRevisiones = [];

        async function initApp() {
            if (!isAuthenticated()) { window.location.href = "index.html"; return; }
            renderLayout('resultados');
            await loadData();
        }

        async function loadData() {
            try {
                // Fetch ONLY revisions as requested to avoid bad joins
                const res = await fetchAPI('/revisiones');

                if (res) {
                    allRevisiones = await res.json();
                    populateFilters();
                    renderResults();
                }
            } catch (e) {
                console.error(e);
                showToast("Error cargando datos", "error");
            }
        }

        function populateFilters() {
            // Unique Niveles from actual revisions
            const niveles = [...new Set(allRevisiones.map(r => r.cargo_nivel).filter(Boolean))].sort();
            const sel = document.getElementById('filterNivel');
            sel.innerHTML = '<option value="">Todos los Niveles</option>';
            niveles.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n;
                opt.textContent = n;
                sel.appendChild(opt);
            });

            // Listeners
            document.getElementById('filterNivel').addEventListener('change', renderResults);
            document.getElementById('filterStatus').addEventListener('change', renderResults);
        }

        function renderResults() {
            const container = document.getElementById('resultsContainer');
            const fNivel = document.getElementById('filterNivel').value;
            const fStatus = document.getElementById('filterStatus').value;

            // 1. Filter Revisions
            let filteredRevs = allRevisiones.filter(r => {
                if (fStatus && r.estado !== fStatus) return false;
                if (fNivel && r.cargo_nivel !== fNivel) return false;
                return true;
            });

            // 2. Group by Cargo (using cargo details in revision)
            const groups = {};
            filteredRevs.forEach(r => {
                const key = r.cargo_detalle || 'Cargo No Especificado';
                if (!groups[key]) {
                    groups[key] = {
                        detalle: r.cargo_detalle,
                        nivel: r.cargo_nivel || '-',
                        tipo: r.cargo_tipo || '-',
                        depende: r.cargo_depende || '-', // Ensure API returns this or handle gracefully
                        revisions: []
                    };
                }
                groups[key].revisions.push(r);
            });

            // Metrics
            const totalSeleccionados = filteredRevs.length;
            const cargosCubiertos = Object.keys(groups).length;

            document.getElementById('statTotalSeleccionados').textContent = totalSeleccionados;
            document.getElementById('statCargosCubiertos').textContent = cargosCubiertos;
            // Tasa de exito is hard to calc without total possible positions, setting to N/A or hiding
            document.getElementById('statTasaExito').textContent = "-";

            let html = '';
            const sortedKeys = Object.keys(groups).sort();

            sortedKeys.forEach(key => {
                const group = groups[key];

                // Sort within cargo (e.g. priority)
                group.revisions.sort((a, b) => {
                    const map = { 'Alta': 3, 'Media': 2, 'Baja': 1 };
                    return (map[b.prioridad] || 0) - (map[a.prioridad] || 0);
                });

                html += `
                <div class="col-12">
                    <div class="card h-100 overflow-hidden border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom d-flex align-items-center justify-content-between py-3">
                            <div class="d-flex align-items-center flex-wrap gap-2">
                                <h5 class="fw-bold mb-0 text-dark me-2">${group.detalle || key}</h5>
                                <span class="badge bg-light text-dark border">${group.nivel}</span>
                                <span class="badge bg-light text-muted border">${group.tipo}</span>
                            </div>
                            <div>
                                <span class="badge bg-success rounded-pill px-3 py-2">
                                    ${group.revisions.length} ${fStatus === 'Seleccionado' ? 'Seleccionados' : 'Candidatos'}
                                </span>
                            </div>
                        </div>
                        <div class="card-body bg-light bg-opacity-25 pb-3">
                            <div class="row g-3">
                `;

                group.revisions.forEach(rev => {
                    const names = (rev.nombres || '?').split(' ');
                    const initials = (names[0][0] + (names[1] ? names[1][0] : '')).toUpperCase();

                    html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="card border border-light shadow-sm h-100 position-relative">
                             <div class="position-absolute top-0 end-0 p-2">
                                 <span class="badge ${getStatusBadge(rev.estado)}">${rev.estado}</span>
                             </div>

                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center fw-bold me-3 shadow-sm" 
                                         style="width: 48px; height: 48px; font-size: 1.1rem;">
                                        ${initials}
                                    </div>
                                    <div class="overflow-hidden">
                                        <h6 class="fw-bold text-dark mb-0 text-truncate" title="${rev.nombres} ${rev.apellidopaterno}">${rev.nombres} ${rev.apellidopaterno}</h6>
                                        <small class="text-muted text-truncate d-block">${rev.profesion || 'Sin profesión'}</small>
                                    </div>
                                </div>
                                <div class="mb-2">
                                     <div class="d-flex justify-content-between small text-muted mb-1">
                                        <span>Prioridad:</span>
                                        <span class="fw-bold text-dark">${rev.prioridad || '-'}</span>
                                     </div>
                                     <div class="d-flex justify-content-between small text-muted mb-1">
                                        <span>RUT:</span>
                                        <span>${rev.rut || '-'}</span>
                                     </div>
                                </div>
                                ${rev.comentarios ? `
                                <div class="bg-light p-2 rounded small text-muted fst-italic border-start border-3 border-primary text-truncate">
                                    "${rev.comentarios}"
                                </div>` : ''}
                            </div>
                        </div>
                    </div>
                    `;
                });

                html += `
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });

            if (html === '') {
                container.innerHTML = `
                <div class="col-12 py-5 text-center">
                    <h4 class="text-muted">No se encontraron resultados</h4>
                    <p class="text-secondary">Intente ajustar los filtros.</p>
                </div>
                `;
            } else {
                container.innerHTML = html;
            }
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'Pendiente': return 'bg-warning text-dark';
                case 'En Revisión': return 'bg-info text-white';
                case 'Entrevista': return 'bg-primary';
                case 'Finalista': return 'bg-purple text-white';
                case 'Seleccionado': return 'bg-success';
                case 'Rechazado': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }
    </script>
</body>

</html>