<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados - Gestión Candidatos</title>
</head>

<body>

    <div class="container pb-5">
        <!-- Header -->
        <div class="row align-items-center mb-5 page-header">
            <div class="col-md-8">
                <h2 class="fw-bold text-dark mb-1">
                    <i class="fas fa-chart-pie text-success me-2"></i>Resultados de Selección
                </h2>
                <p class="text-muted mb-0">Resumen ejecutivo de candidatos seleccionados por cargo.</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-outline-secondary" onclick="window.print()">
                    <i class="fas fa-print me-2"></i> Imprimir Reporte
                </button>
            </div>
        </div>

        <!-- Metric Cards -->
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card bg-white h-100 border-0 shadow-sm position-relative overflow-hidden">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="text-uppercase fw-bold text-muted small mb-1">Cargos Cubiertos</p>
                                <h2 class="fw-bold text-dark mb-0" id="statCargosCubiertos">-</h2>
                            </div>
                            <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                                <i class="fas fa-check-double text-success fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-white h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="text-uppercase fw-bold text-muted small mb-1">Candidatos Seleccionados</p>
                                <h2 class="fw-bold text-primary mb-0" id="statTotalSeleccionados">-</h2>
                            </div>
                            <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                                <i class="fas fa-users text-primary fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-white h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="text-uppercase fw-bold text-muted small mb-1">Tasa de Éxito</p>
                                <h2 class="fw-bold text-info mb-0" id="statTasaExito">0%</h2>
                            </div>
                            <div class="bg-info bg-opacity-10 p-3 rounded-circle">
                                <i class="fas fa-chart-line text-info fa-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4 border-0">
            <div class="card-body p-3">
                <div class="row g-2 align-items-center">
                    <div class="col-auto"><i class="fas fa-filter text-muted me-2"></i></div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm border-0 bg-light fw-bold" id="filterNivel">
                            <option value="">Todos los Niveles</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm border-0 bg-light fw-bold" id="filterStatus">
                            <option value="Seleccionado" selected>Solo Seleccionados</option>
                            <option value="">Todos los Estados</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results List -->
        <div id="resultsContainer" class="row g-4">
            <!-- Injected via JS -->
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Analizando resultados...</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="common.js"></script>
    <script>
        document.addEventListener('libsLoaded', initApp);
        // Fallback
        if (typeof isAuthenticated !== 'undefined' && isAuthenticated()) initApp();

        let allRevisiones = [];
        let allCargos = [];

        async function initApp() {
            if (!isAuthenticated()) { window.location.href = "index.html"; return; }
            renderLayout('resultados');
            await loadData();
        }

        async function loadData() {
            try {
                const [resRev, resCar] = await Promise.all([
                    fetchAPI('/revisiones'),
                    fetchAPI('/cargos')
                ]);

                if (resRev && resCar) {
                    allRevisiones = await resRev.json();
                    allCargos = await resCar.json();

                    populateFilters();
                    renderResults();
                }
            } catch (e) {
                console.error(e);
                showToast("Error cargando datos", "error");
            }
        }

        function populateFilters() {
            // Unique Niveles
            const niveles = [...new Set(allCargos.map(c => c.nivel).filter(Boolean))].sort();
            const sel = document.getElementById('filterNivel');
            sel.innerHTML = '<option value="">Todos los Niveles</option>';
            niveles.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n;
                opt.textContent = n;
                sel.appendChild(opt);
            });

            // Listeners
            document.getElementById('filterNivel').addEventListener('change', renderResults);
            document.getElementById('filterStatus').addEventListener('change', renderResults);
        }

        function renderResults() {
            const container = document.getElementById('resultsContainer');
            const fNivel = document.getElementById('filterNivel').value;
            const fStatus = document.getElementById('filterStatus').value; // Usually "Seleccionado"

            // 1. Filter Cargos first suitable for display results
            let targetCargos = allCargos;
            if (fNivel) targetCargos = targetCargos.filter(c => c.nivel === fNivel);

            // 2. Map Revisions to Cargos
            // We want to show Cargos that have selected candidates (or all if filter allows)
            let totalSeleccionados = 0;
            let cargosConSeleccion = 0;

            let html = '';

            targetCargos.forEach(cargo => {
                // Get revisions for this cargo
                let revisions = allRevisiones.filter(r => r.idcargo == cargo.idcargo || (r.cargo_detalle === cargo.detalle)); // Using cargo_Link logic from API join
                // Actually the API /revisiones returns flattened logic: cargo_detalle, cargo_nivel... but we usually don't get idCargo directly in revision unless we map it.
                // Wait, GET /revisiones SQL: "SELECT r.*, ... c.nivel, c.detalle ..."
                // It does NOT return c.idCargo explicitly in the SELECT list I viewed earlier?
                // Step 576 viewed app1.py lines 530+:
                // "SELECT r.*, p.idPersona... JOIN Cargo c... "
                // It does select r.*. r has idPostulacion. Postulacion has idCargo.
                // But the join didn't explicitly select c.idCargo as cargo_id? 
                // However, r.* likely doesn't have idCargo. p has idCargo.
                // The query didn't select p.idCargo explicitly?
                // Let's rely on matching loose Strings (Details) or try to deduce.
                // Actually, let's look at the data structure. 'r' is from Revision table.
                // Revision table has idPostulacion.
                // We will filter by checking if any revision's `cargo_detalle` matches this cargo's `detalle`. Reliable enough.

                // Filter by Status
                if (fStatus) {
                    revisions = revisions.filter(r => r.estado === fStatus);
                } else {
                    // If no status filter, maybe show "Seleccionado" and "Finalista" prioritized?
                    // Or just show all? The prompt asked for "Results".
                }

                // If filtering by "Seleccionado", skip cargos with 0 selections?
                // Maybe yes, to keep it clean.
                if (fStatus && revisions.length === 0) return;

                if (revisions.length > 0) cargosConSeleccion++;
                totalSeleccionados += revisions.length;

                // Sort revisions by ranking (Best Fit -> 100, then others)
                // Assuming 'fitPolitico' or similar is score. Or Priority.
                revisions.sort((a, b) => {
                    const map = { 'Alta': 3, 'Media': 2, 'Baja': 1 };
                    return (map[b.prioridad] || 0) - (map[a.prioridad] || 0);
                });

                // Build Card for Cargo
                html += `
                <div class="col-12">
                    <div class="card h-100 overflow-hidden">
                        <div class="card-header bg-white border-bottom d-flex align-items-center justify-content-between">
                            <div>
                                <span class="badge bg-light text-dark border me-2">${cargo.nivel}</span>
                                <span class="badge bg-light text-muted border me-2">${cargo.tipo}</span>
                                <h5 class="fw-bold d-inline-block align-middle mb-0 text-dark">${cargo.detalle}</h5>
                            </div>
                            <div>
                                <span class="badge bg-success rounded-pill px-3 py-2">
                                    ${revisions.length} Seleccionados
                                </span>
                            </div>
                        </div>
                        <div class="card-body bg-light bg-opacity-10">
                            <div class="row g-3">
                `;

                revisions.forEach(rev => {
                    // Initials for avatar
                    const names = (rev.nombres || '?').split(' ');
                    const initials = (names[0][0] + (names[1] ? names[1][0] : '')).toUpperCase();

                    const score = rev.analisiscvia ? " IA" : ""; // Placeholder for score if parsed

                    html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="card border-0 shadow-sm h-100 position-relative">
                            <div class="position-absolute top-0 end-0 p-2">
                                <span class="badge ${getStatusBadge(rev.estado)}">${rev.estado}</span>
                            </div>
                            <div class="card-body d-flex align-items-center gap-3">
                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center fw-bold shadow-sm" 
                                     style="width: 50px; height: 50px; flex-shrink: 0; font-size: 1.1rem;">
                                    ${initials}
                                </div>
                                <div class="overflow-hidden">
                                    <h6 class="fw-bold text-dark mb-0 text-truncate">${rev.nombres} ${rev.apellidopaterno}</h6>
                                    <small class="text-muted d-block text-truncate">${rev.profesion || 'Profesional'}</small>
                                    <div class="d-flex align-items-center mt-2 gap-2">
                                        <span class="badge bg-light text-secondary border small"><i class="fas fa-flag me-1"></i>${rev.prioridad || '-'}</span>
                                        ${rev.rut ? `<small class="text-muted" style="font-size:0.75rem">${rev.rut}</small>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-0 pt-0">
                                <small class="text-muted fst-italic line-clamp-2" style="font-size: 0.8rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                    ${rev.comentarios || 'Sin comentarios adicionales.'}
                                </small>
                            </div>
                        </div>
                    </div>
                    `;
                });

                html += `
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });

            if (html === '') {
                container.innerHTML = `
                <div class="col-12 py-5 text-center">
                    <img src="https://cdni.iconscout.com/illustration/premium/thumb/empty-state-2130362-1800926.png" style="max-width: 200px; opacity: 0.5;">
                    <h4 class="text-muted mt-3">No hay resultados encontrados</h4>
                    <p class="text-secondary">Intente ajustar los filtros de búsqueda.</p>
                </div>
                `;
            } else {
                container.innerHTML = html;
            }

            // Update Metrics
            document.getElementById('statTotalSeleccionados').textContent = totalSeleccionados;
            document.getElementById('statCargosCubiertos').textContent = cargosConSeleccion;

            // Calculate pseudo "Success Rate" (Cargos with selection / Total Filtered Cargos)
            const tasa = targetCargos.length > 0 ? Math.round((cargosConSeleccion / targetCargos.length) * 100) : 0;
            document.getElementById('statTasaExito').textContent = `${tasa}%`;
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'Pendiente': return 'bg-warning text-dark';
                case 'En Revisión': return 'bg-info text-white';
                case 'Entrevista': return 'bg-primary';
                case 'Finalista': return 'bg-purple text-white'; // Custom needed? Use primary
                case 'Seleccionado': return 'bg-success';
                case 'Rechazado': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }
    </script>
</body>

</html>