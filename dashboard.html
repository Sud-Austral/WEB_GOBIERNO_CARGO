<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gestión Candidatos</title>
</head>

<body>

    <div class="container-fluid my-4">
        <!-- Welcome Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-white border-0 shadow-sm">
                    <div class="card-body d-flex justify-content-between align-items-center p-4">
                        <div>
                            <h2 class="fw-bold text-dark mb-1">Dashboard General</h2>
                            <p class="text-muted mb-0">Resumen ejecutivo y métricas clave del proceso de selección.</p>
                        </div>
                        <div class="text-end">
                            <h6 class="text-muted text-uppercase small fw-bold">Fecha Actual</h6>
                            <h4 class="fw-bold text-primary mb-0" id="currentDate">-</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 10 Key Stats Grid -->
        <div class="row g-3 mb-4">
            <!-- Row 1 -->
            <div class="col-md-2 col-sm-4">
                <div class="card border-0 shadow-sm h-100 bg-light">
                    <div class="card-body p-3 text-center">
                        <h6 class="text-muted small text-uppercase fw-bold mb-2">Total Candidatos</h6>
                        <h3 class="fw-bold text-dark mb-0" id="statTotalPersonas">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="card border-0 shadow-sm h-100 bg-light">
                    <div class="card-body p-3 text-center">
                        <h6 class="text-muted small text-uppercase fw-bold mb-2">Total Cargos</h6>
                        <h3 class="fw-bold text-dark mb-0" id="statTotalCargos">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="card border-0 shadow-sm h-100 bg-light">
                    <div class="card-body p-3 text-center">
                        <h6 class="text-muted small text-uppercase fw-bold mb-2">Vacantes Abiertas</h6>
                        <h3 class="fw-bold text-warning mb-0" id="statVacantes">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="card border-0 shadow-sm h-100 bg-light">
                    <div class="card-body p-3 text-center">
                        <h6 class="text-muted small text-uppercase fw-bold mb-2">Total Postulaciones</h6>
                        <h3 class="fw-bold text-primary mb-0" id="statTotalPostulaciones">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="card border-0 shadow-sm h-100 bg-light">
                    <div class="card-body p-3 text-center">
                        <h6 class="text-muted small text-uppercase fw-bold mb-2">Postulaciones Hoy</h6>
                        <h3 class="fw-bold text-info mb-0" id="statPostulacionesHoy">-</h3>
                    </div>
                </div>
            </div>

            <!-- Row 2 -->
            <div class="col-md-2 col-sm-4">
                <div class="card border-0 shadow-sm h-100 bg-light">
                    <div class="card-body p-3 text-center">
                        <h6 class="text-muted small text-uppercase fw-bold mb-2">Revisiones Pendientes</h6>
                        <h3 class="fw-bold text-danger mb-0" id="statRevisionesPendientes">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="card border-0 shadow-sm h-100 bg-success text-white">
                    <div class="card-body p-3 text-center">
                        <h6 class="text-white-50 small text-uppercase fw-bold mb-2">Seleccionados</h6>
                        <h3 class="fw-bold text-white mb-0" id="statSeleccionados">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="card border-0 shadow-sm h-100 bg-light">
                    <div class="card-body p-3 text-center">
                        <h6 class="text-muted small text-uppercase fw-bold mb-2">% Cobertura</h6>
                        <h3 class="fw-bold text-dark mb-0" id="statCobertura">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="card border-0 shadow-sm h-100 bg-light">
                    <div class="card-body p-3 text-center">
                        <h6 class="text-muted small text-uppercase fw-bold mb-2">Prom. Post/Cargo</h6>
                        <h3 class="fw-bold text-dark mb-0" id="statPromedio">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="card border-0 shadow-sm h-100 bg-light">
                    <div class="card-body p-3 text-center">
                        <h6 class="text-muted small text-uppercase fw-bold mb-2">Cargos Críticos</h6>
                        <h3 class="fw-bold text-danger mb-0" id="statCargosCriticos">-</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Left Column: Tasks & Lists -->
            <div class="col-lg-8">
                <!-- Section: Cargos por Completar -->
                <div class="card shadow-sm border-0 mb-4 ms-2">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold text-dark mb-0">
                            <i class="fas fa-clipboard-list text-warning me-2"></i>Cargos por Completar / Seleccionar
                        </h5>
                        <span class="badge bg-warning text-dark fs-6" id="badgeCargosIncompletos">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Cargo</th>
                                        <th>Nivel / Área</th>
                                        <th class="text-center">Postulantes</th>
                                        <th class="text-center">Estado</th>
                                        <th class="text-end pe-4">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="tableCargosIncompletos">
                                    <tr>
                                        <td colspan="5" class="text-center py-4">Cargando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-center py-2">
                        <a href="seleccion.html" class="text-decoration-none small fw-bold">Ver Panel de Selección
                            Completo <i class="fas fa-arrow-right ms-1"></i></a>
                    </div>
                </div>

                <!-- Custom Section 1: Ultima Actividad -->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white py-3">
                        <h5 class="fw-bold text-dark mb-0">
                            <i class="fas fa-history text-primary me-2"></i>Última Actividad Reciente
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush" id="listActivity">
                            <div class="text-center py-3 text-muted">Cargando actividad...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Stats & Charts -->
            <div class="col-lg-4">

                <!-- Custom Section 2: Funnel -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="fw-bold text-dark mb-0">
                            <i class="fas fa-filter text-info me-2"></i>Embudo de Selección
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-column gap-3">
                            <div class="p-3 bg-light rounded position-relative overflow-hidden">
                                <div class="d-flex justify-content-between align-items-center position-relative"
                                    style="z-index: 2;">
                                    <span class="fw-bold">Total Postulaciones</span>
                                    <span class="badge bg-secondary rounded-pill" id="funnelTotal">-</span>
                                </div>
                                <div class="progress mt-2" style="height: 6px;">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>

                            <div class="p-3 bg-light rounded position-relative">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">En Revisión</span>
                                    <span class="badge bg-secondary rounded-pill" id="funnelRevision">-</span>
                                </div>
                                <div class="progress mt-2" style="height: 6px;">
                                    <div class="progress-bar bg-info" role="progressbar" id="progFunnelRevision"
                                        style="width: 0%"></div>
                                </div>
                            </div>

                            <div class="p-3 bg-light rounded position-relative">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">Preseleccionados</span>
                                    <span class="badge bg-secondary rounded-pill" id="funnelPre">-</span>
                                </div>
                                <div class="progress mt-2" style="height: 6px;">
                                    <div class="progress-bar bg-warning" role="progressbar" id="progFunnelPre"
                                        style="width: 0%"></div>
                                </div>
                            </div>

                            <div class="p-3 bg-success text-white rounded position-relative shadow-sm">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">Seleccionados Finales</span>
                                    <span class="badge bg-white text-success rounded-pill" id="funnelSelected">-</span>
                                </div>
                                <div class="progress mt-2 bg-success-soft"
                                    style="height: 6px; background-color: rgba(255,255,255,0.3);">
                                    <div class="progress-bar bg-white" role="progressbar" id="progFunnelSelected"
                                        style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Custom Section 3: Distribution by Gender -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="fw-bold text-dark mb-0">
                            <i class="fas fa-venus-mars text-purple me-2"></i>Distribución Género
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="genderStats">
                            <!-- Loaded via JS -->
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card shadow-sm border-0 bg-primary text-white">
                    <div class="card-body p-4 text-center">
                        <h5 class="fw-bold mb-3">¿Acciones Rápidas?</h5>
                        <div class="d-grid gap-2">
                            <a href="seleccion.html" class="btn btn-light fw-bold text-primary">Ir a Selección</a>
                            <a href="postulaciones.html" class="btn btn-outline-light">Nueva Postulación</a>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script src="common.js"></script>
    <script>
        document.addEventListener('libsLoaded', initDashboard);
        // Fallback init
        if (window.jQuery && window.isAuthenticated) initDashboard();

        let allPersonas = [];
        let allCargos = [];
        let allPostulaciones = [];
        let allRevisiones = [];

        async function initDashboard() {
            if (!isAuthenticated()) { window.location.href = "index.html"; return; }
            renderLayout('dashboard');

            // Set Date
            const now = new Date();
            document.getElementById('currentDate').innerText = now.toLocaleDateString('es-CL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            await loadData();
            calculateStats();
        }

        async function loadData() {
            // Fetch all data
            // We use timestamps to avoid caching
            const t = new Date().getTime();

            const [pRes, cRes, poRes, rRes] = await Promise.all([
                fetchAPI(`/personas?t=${t}`),
                fetchAPI(`/cargos?t=${t}`),
                fetchAPI(`/postulaciones?t=${t}`),
                fetchAPI(`/revisiones?t=${t}`)
            ]);

            if (pRes) allPersonas = await pRes.json();
            if (cRes) allCargos = await cRes.json();
            if (poRes) allPostulaciones = await poRes.json();
            if (rRes) allRevisiones = await rRes.json();
        }

        function calculateStats() {
            // 1. Basic Counts
            const totalPersonas = allPersonas.length;
            const totalCargos = allCargos.length;
            const totalPostulaciones = allPostulaciones.length;

            // 2. Calculated Stats
            // Selected candidates count
            const selectedCount = allRevisiones.filter(r => r.estado === 'Seleccionado').length;

            // Vacancies open (Total Cargos - Selected)
            // Assuming 1 cargo = 1 vacancy for simplicity based on previous logic
            const vacantes = totalCargos - selectedCount;

            // Postulations Today
            const todayStr = new Date().toISOString().split('T')[0];
            const postsToday = allPostulaciones.filter(p => p.fechapostulacion && p.fechapostulacion.startsWith(todayStr)).length;

            // Pending Revisions (Status 'Pendiente')
            const pendingRevisions = allRevisiones.filter(r => r.estado === 'Pendiente').length;

            // Coverage %
            const coverage = totalCargos > 0 ? Math.round((selectedCount / totalCargos) * 100) : 0;

            // Avg Postulants per Cargo
            const avgPostulantes = totalCargos > 0 ? (totalPostulaciones / totalCargos).toFixed(1) : 0;

            // Critical Cargos (0 postulants)
            // Map cargo IDs from postulations
            const cargosWithApplicants = new Set(allPostulaciones.map(p => p.idcargo));
            const criticalCargosCount = allCargos.filter(c => !cargosWithApplicants.has(c.idcargo)).length;

            // --- Render Top Stats ---
            setText('statTotalPersonas', totalPersonas);
            setText('statTotalCargos', totalCargos);
            setText('statVacantes', vacantes);
            setText('statTotalPostulaciones', totalPostulaciones);
            setText('statPostulacionesHoy', postsToday);
            setText('statRevisionesPendientes', pendingRevisions);
            setText('statSeleccionados', selectedCount);
            setText('statCobertura', `${coverage}%`);
            setText('statPromedio', avgPostulantes);
            setText('statCargosCriticos', criticalCargosCount);

            // --- Render Cargos Incompletos ---
            renderIncompleteCargos();

            // --- Render Funnel ---
            renderFunnel(totalPostulaciones, selectedCount);

            // --- Render Gender Stats ---
            renderGenderStats();

            // --- Render Activity ---
            renderActivity();
        }

        function renderIncompleteCargos() {
            // Filter cargos NOT selected
            // First find IDs of selected cargos
            const selectedJobNames = new Set(allRevisiones.filter(r => r.estado === 'Seleccionado').map(r => r.cargo_detalle));

            // Logic note: 'allCargos' has idCargo, depends, nivel, tipo, detalle.
            // 'allRevisiones' links via cargo_detalle mostly in previous code, but ideally idCargo.
            // Let's use cargo names (detalle) as the linking key since that's what we used in selection view.

            const incompleteCargos = allCargos.filter(c => !selectedJobNames.has(c.detalle));

            setText('badgeCargosIncompletos', incompleteCargos.length);

            const tbody = document.getElementById('tableCargosIncompletos');
            if (incompleteCargos.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-success py-4"><i class="fas fa-check-circle me-2"></i>¡Todos los cargos han sido cubiertos!</td></tr>`;
                return;
            }

            let html = '';
            // Show only top 10 to avoid huge list
            const displayList = incompleteCargos.slice(0, 10);

            displayList.forEach(c => {
                // Count applicants for this cargo
                const applicants = allPostulaciones.filter(p => p.idcargo == c.idcargo).length;

                html += `
                    <tr>
                        <td class="ps-4 fw-bold text-dark">${c.detalle}</td>
                        <td><small class="text-muted d-block">${c.nivel || '-'}</small><small class="text-secondary">${c.dependede || c.dependeDe || ''}</small></td>
                        <td class="text-center"><span class="badge bg-light text-dark border">${applicants}</span></td>
                        <td class="text-center"><span class="badge bg-warning text-dark">Vacante</span></td>
                        <td class="text-end pe-4">
                            <a href="seleccion.html" class="btn btn-sm btn-outline-primary"><i class="fas fa-search me-1"></i>Seleccionar</a>
                        </td>
                    </tr>
                `;
            });

            if (incompleteCargos.length > 10) {
                html += `<tr><td colspan="5" class="text-center small text-muted">Mostrando 10 de ${incompleteCargos.length} cargos vacantes...</td></tr>`;
            }

            tbody.innerHTML = html;
        }

        function renderFunnel(total, selected) {
            // Logic:
            // Total = Postulaciones
            // Revision = Postulaciones that have a revision entry
            // Preselected = Revision status 'Preseleccionado'
            // Selected = Revision status 'Seleccionado'

            const inRevision = allRevisiones.length; // Basically all revisions started
            const preselected = allRevisiones.filter(r => r.estado === 'Preseleccionado').length;

            setText('funnelTotal', total);
            setText('funnelRevision', inRevision);
            setText('funnelPre', preselected);
            setText('funnelSelected', selected);

            // Calculate widths relative to total
            const pRev = total > 0 ? (inRevision / total) * 100 : 0;
            const pPre = total > 0 ? (preselected / total) * 100 : 0;
            const pSel = total > 0 ? (selected / total) * 100 : 0;

            document.getElementById('progFunnelRevision').style.width = `${pRev}%`;
            document.getElementById('progFunnelPre').style.width = `${pPre}%`;
            document.getElementById('progFunnelSelected').style.width = `${pSel}%`;
        }

        function renderGenderStats() {
            const counts = {};
            allPersonas.forEach(p => {
                const g = p.genero || 'No especificado';
                counts[g] = (counts[g] || 0) + 1;
            });

            const total = allPersonas.length;
            let html = '';

            const colors = ['bg-primary', 'bg-info', 'bg-warning', 'bg-secondary'];
            let i = 0;

            Object.keys(counts).forEach(gender => {
                const count = counts[gender];
                const pct = total > 0 ? Math.round((count / total) * 100) : 0;
                const color = colors[i % colors.length];
                i++;

                html += `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>${gender}</span>
                            <span class="fw-bold">${count} (${pct}%)</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar ${color}" role="progressbar" style="width: ${pct}%"></div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('genderStats').innerHTML = html || '<p class="text-muted text-center">No hay datos demográficos.</p>';
        }

        function renderActivity() {
            // Get last 5 postulations
            const recent = allPostulaciones
                .sort((a, b) => new Date(b.fechapostulacion) - new Date(a.fechapostulacion))
                .slice(0, 5);

            let html = '';
            if (recent.length === 0) {
                html = '<div class="text-center py-3 text-muted">Sin actividad reciente.</div>';
            } else {
                recent.forEach(p => {
                    const date = new Date(p.fechapostulacion).toLocaleDateString();
                    html += `
                        <div class="list-group-item bg-transparent border-0 px-0 d-flex gap-3 align-items-center">
                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center flex-shrink-0" style="width: 40px; height: 40px;">
                                <i class="fas fa-user-plus text-primary"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 small fw-bold text-dark">${p.nombres} ${p.apellidopaterno}</h6>
                                <p class="mb-0 x-small text-muted">Se postuló a <span class="text-dark">${p.cargo_detalle || 'un cargo'}</span></p>
                            </div>
                            <div class="ms-auto text-end">
                                <small class="text-muted x-small">${date}</small>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('listActivity').innerHTML = html;
        }

        function setText(id, val) {
            const el = document.getElementById(id);
            if (el) el.innerText = val;
        }

    </script>
    <style>
        .x-small {
            font-size: 0.75rem;
        }

        .bg-success-soft {
            background-color: rgba(25, 135, 84, 0.1);
        }
    </style>
</body>

</html>