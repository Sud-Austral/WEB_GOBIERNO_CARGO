<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postulaciones - Gestión Candidatos</title>
</head>

<body>

    <div class="container-xl my-5">
        <div class="row align-items-center mb-5 page-header">
            <div class="col-md-8">
                <h2 class="fw-bold mb-1"
                    style="background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    <i class="fas fa-file-signature me-2 text-primary"></i>Postulaciones
                </h2>
                <p class="text-muted mb-0">Gestión de las postulaciones y asignaciones a cargos.</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary shadow-sm" onclick="openNewPostModal()">
                    <i class="fas fa-plus me-1"></i> Nueva Postulación
                </button>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="card border-0 shadow-sm mb-4 bg-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                    <h6 class="fw-bold text-muted mb-0 text-uppercase small letter-spacing-1"><i
                            class="fas fa-filter me-2"></i>Filtros</h6>
                    <button class="btn btn-sm btn-light text-muted" onclick="clearFilters()">
                        <i class="fas fa-undo me-1"></i> Limpiar
                    </button>
                </div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">Buscar</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light border-end-0"><i
                                    class="fas fa-search text-muted"></i></span>
                            <input type="text" id="filterSearch" class="form-control border-start-0 ps-0"
                                placeholder="Nombre, cargo...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">Nivel</label>
                        <select id="filterNivel" class="form-select form-select-sm">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">Dependencia (Jefatura)</label>
                        <select id="filterDepende" class="form-select form-select-sm">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted fw-bold">Tipo de Cargo</label>
                        <select id="filterTipo" class="form-select form-select-sm">
                            <option value="">Todos</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table id="postTable" class="table table-hover align-middle w-100 mb-0">
                        <thead class="bg-light bg-opacity-50">
                            <tr>
                                <th class="ps-4">ID</th>
                                <th>Candidato</th>
                                <th>Cargo</th>
                                <th>Fecha</th>
                                <th class="text-end pe-4">Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Create/Edit -->
    <div class="modal fade" id="newPostModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Nueva Postulación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="postForm">
                        <div class="mb-4">
                            <label class="form-label fw-bold">1. Seleccionar Persona</label>
                            <select id="idPersona" class="form-select select2-persona" style="width: 100%;" required>
                                <option value="">Buscar persona...</option>
                            </select>
                        </div>

                        <div class="mb-3" id="cargoFiltersSection">
                            <label class="form-label fw-bold">2. Filtrar Cargo</label>
                            <div class="card bg-light border-0">
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label small">Nivel</label>
                                            <select id="cF_Nivel" class="form-select select2-simple">
                                                <option value="">Todos</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Depende De</label>
                                            <select id="cF_Depende" class="form-select select2-simple">
                                                <option value="">Todos</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Tipo</label>
                                            <select id="cF_Tipo" class="form-select select2-simple">
                                                <option value="">Todos</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">3. Seleccionar Cargo Final</label>
                            <select id="idCargo" class="form-select select2-cargo" style="width: 100%;" required>
                                <option value="">Seleccione filtros primero...</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" form="postForm" class="btn btn-primary">Guardar Postulación</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal View Details -->
    <div class="modal fade" id="viewPostModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Detalle de Postulación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="viewPostContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="btnEditFromView">Editar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        document.addEventListener('libsLoaded', initApp);
        // Only init immediately if both jQuery AND DataTables are loaded
        if (window.jQuery && $.fn && $.fn.DataTable) initApp();

        let allCargos = [];
        let allPostulacionesData = [];
        let dataTable;
        let currentEditId = null;

        function initApp() {
            if (!isAuthenticated()) { window.location.href = "index.html"; return; }
            renderLayout('postulaciones');

            // Setup Custom Filtering for DataTables
            $.fn.dataTable.ext.search.push(
                function (settings, data, dataIndex, rowData) {
                    if (settings.nTable.id !== 'postTable') return true;

                    const fNivel = $('#filterNivel').val();
                    const fDepende = $('#filterDepende').val();
                    const fTipo = $('#filterTipo').val();

                    if (!fNivel && !fDepende && !fTipo) return true;

                    if (fNivel && rowData.cargo_nivel !== fNivel) return false;
                    if (fDepende && rowData.cargo_depende !== fDepende) return false;
                    if (fTipo && rowData.cargo_tipo !== fTipo) return false;

                    return true;
                }
            );

            // Init DataTables
            dataTable = $('#postTable').DataTable({
                language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json" },
                order: [[0, "desc"]],
                columns: [
                    { data: "idpostulacion", width: "5%" },
                    { data: null, render: (d) => `<div class="fw-bold">${d.nombres} ${d.apellidopaterno}</div><div class="small text-muted">${d.rut || ''}</div>` },
                    {
                        data: null,
                        render: (d) => {
                            let html = `<div class="fw-bold">${d.cargo_detalle || 'Cargo desconocido'}</div>`;
                            html += `<div class="small text-muted">${d.cargo_tipo || ''}</div>`;
                            if (d.cargo_nivel) html += `<span class="badge bg-secondary">${d.cargo_nivel}</span>`;
                            return html;
                        }
                    },
                    { data: "fechapostulacion", render: (d) => new Date(d).toLocaleDateString() },
                    {
                        data: null,
                        className: "text-end pe-4",
                        render: (d) => `
                            <div class="d-flex justify-content-end gap-2">
                                <button class="btn btn-sm btn-light text-info" onclick="viewPost(${d.idpostulacion})" title="Ver"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-sm btn-light text-primary" onclick="editPost(${d.idpostulacion})" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-light text-danger" onclick="deletePost(${d.idpostulacion})" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        `
                    }
                ]
            });

            // Filtering Event Listeners - Bidirectional Cascading
            $('#filterNivel').on('change', function () {
                updateAllFilters('nivel');
                dataTable.draw();
            });
            $('#filterDepende').on('change', function () {
                updateAllFilters('depende');
                dataTable.draw();
            });
            $('#filterTipo').on('change', function () {
                updateAllFilters('tipo');
                dataTable.draw();
            });
            $('#filterSearch').on('keyup', function () {
                dataTable.search(this.value).draw();
            });

            loadData();
            initFilters();

            // Form Submit
            $('#postForm').on('submit', async function (e) {
                e.preventDefault();
                const btn = $(this).find('button[type="submit"]');
                btn.prop('disabled', true);

                const body = {
                    idPersona: $('#idPersona').val(),
                    idCargo: $('#idCargo').val()
                };

                // DUPLICATE VALIDATION
                // Check if this same combination already exists
                const isDuplicate = allPostulacionesData.find(p =>
                    p.idpersona == body.idPersona &&
                    p.idcargo == body.idCargo &&
                    p.idpostulacion != currentEditId // Ignore if it's the current record being edited
                );

                if (isDuplicate) {
                    showToast("Error: Esta persona ya tiene una postulación activa para este cargo.", "error");
                    btn.prop('disabled', false);
                    return;
                }

                let res;
                if (currentEditId) {
                    res = await fetchAPI(`/postulaciones/${currentEditId}`, {
                        method: 'PUT',
                        body: JSON.stringify(body)
                    });
                } else {
                    res = await fetchAPI('/postulaciones', {
                        method: 'POST',
                        body: JSON.stringify(body)
                    });
                }

                if (res && res.ok) {
                    const responseData = await res.json(); // Parse response to get ID

                    showToast(currentEditId ? "Postulación actualizada" : "Postulación creada exitosamente");
                    $('#newPostModal').modal('hide');
                    loadData();

                    // QUICK ACTION: Redirect to create Revision manually
                    if (!currentEditId && responseData.id) {
                        setTimeout(() => {
                            if (confirm("¿Desea ir al formulario de revisión para completar los detalles ahora?")) {
                                window.location.href = `revisiones.html?createFor=${responseData.id}`;
                            }
                        }, 300);
                    }
                } else {
                    showToast("Error al guardar postulación", "error");
                }
                btn.prop('disabled', false);
            });
        }

        async function loadData() {
            // Load Table Data
            const res = await fetchAPI('/postulaciones');
            if (res) {
                const data = await res.json();
                allPostulacionesData = data;
                dataTable.clear().rows.add(data).draw();
                populateMainFilters(data);
            }

            // Load Cargos for memory (form filtering)
            const resC = await fetchAPI('/cargos');
            if (resC) {
                allCargos = await resC.json();
                updateFormFilterOptions(); // Populate form filter dropdowns
            }

            // Load Personas for Select2
            const resP = await fetchAPI('/personas');
            if (resP) {
                const personas = await resP.json();
                const mapped = personas.map(p => ({
                    id: p.idpersona,
                    text: `${p.rut} - ${p.nombres} ${p.apellidopaterno || ''}`
                }));
                const sel = $('.select2-persona');
                sel.empty(); // Clear old options to avoid duplicates on reload
                sel.append('<option value="">Buscar persona...</option>');
                sel.select2({
                    theme: 'bootstrap-5',
                    dropdownParent: $('#newPostModal'),
                    data: mapped,
                    placeholder: "Buscar por nombre o RUT...",
                    allowClear: true
                });
            }
        }

        function populateMainFilters(data) {
            const niveles = [...new Set(data.map(d => d.cargo_nivel).filter(Boolean))].sort();
            fillSelect('#filterNivel', niveles);
            updateAllFilters('init');
        }

        function updateAllFilters(changedFilter) {
            const nivel = $('#filterNivel').val();
            const depende = $('#filterDepende').val();
            const tipo = $('#filterTipo').val();

            // Filter data based on current selections
            let filtered = allPostulacionesData;
            if (nivel) filtered = filtered.filter(d => d.cargo_nivel == nivel);
            if (depende) filtered = filtered.filter(d => d.cargo_depende == depende);
            if (tipo) filtered = filtered.filter(d => d.cargo_tipo == tipo);

            // Update all dropdowns except the one that changed
            if (changedFilter !== 'nivel') {
                const niveles = [...new Set(filtered.map(d => d.cargo_nivel).filter(Boolean))].sort();
                fillSelect('#filterNivel', niveles, nivel);
            }

            if (changedFilter !== 'depende') {
                const dependes = [...new Set(filtered.map(d => d.cargo_depende).filter(Boolean))].sort();
                fillSelect('#filterDepende', dependes, depende);
            }

            if (changedFilter !== 'tipo') {
                const tipos = [...new Set(filtered.map(d => d.cargo_tipo).filter(Boolean))].sort();
                fillSelect('#filterTipo', tipos, tipo);
            }
        }

        function fillSelect(selector, values, currentSelection) {
            const el = $(selector);
            const current = currentSelection !== undefined ? currentSelection : el.val();
            el.empty().append('<option value="">Todos</option>');
            values.forEach(v => {
                el.append(new Option(v, v));
            });
            if (current && values.includes(current)) el.val(current);
            else if (current) el.val('');
        }

        function clearFilters() {
            $('#filterSearch').val('');
            $('#filterNivel').val('').trigger('change');
            // Don't manually reset depende/tipo - let cascade handle it
            dataTable.search('').draw();
        }

        // -----------------------
        // Form Logic
        // -----------------------

        function openNewPostModal() {
            currentEditId = null;
            $('#postForm')[0].reset();
            $('#idPersona').val(null).trigger('change');
            $('#idCargo').val(null).trigger('change');
            // Reset form filters
            updateFormFilterOptions();

            $('#newPostModal .modal-title').text("Nueva Postulación");
            $('#newPostModal button[type="submit"]').text("Guardar Postulación");
            $('#newPostModal').modal('show');
        }

        function editPost(id) {
            const row = dataTable.rows().data().toArray().find(r => r.idpostulacion == id);
            if (!row) return;

            currentEditId = id;

            // Set Persona
            $('#idPersona').val(row.idpersona).trigger('change');

            // Find Cargo for pre-filling filters
            const cargo = allCargos.find(c => c.idcargo == row.idcargo);
            if (cargo) {
                // Set filters to match this cargo
                $('#cF_Nivel').val(cargo.nivel).trigger('change');
                setTimeout(() => {
                    $('#cF_Depende').val(cargo.dependede).trigger('change');
                    setTimeout(() => {
                        $('#cF_Type').val(cargo.tipo).trigger('change');
                        $('#cF_Nivel').val('').trigger('change');
                        $('#cF_Depende').val('').trigger('change');
                        $('#cF_Tipo').val('').trigger('change');

                        // Wait for options to rebuild
                        updateCargoSelect();
                        $('#idCargo').val(row.idcargo).trigger('change');
                    }, 50);
                }, 50);
            }

            $('#newPostModal .modal-title').text("Editar Postulación");
            $('#newPostModal button[type="submit"]').text("Actualizar");
            $('#newPostModal').modal('show');
        }

        function viewPost(id) {
            const d = dataTable.rows().data().toArray().find(r => r.idpostulacion == id);
            if (!d) return;

            const html = `
                <div class="mb-3">
                    <label class="small text-muted fw-bold">ID Postulación</label>
                    <div>${d.idpostulacion}</div>
                </div>
                <div class="mb-3">
                    <label class="small text-muted fw-bold">Candidato</label>
                    <div>${d.nombres} ${d.apellidopaterno}</div>
                    <div class="small">${d.rut}</div>
                </div>
                <div class="mb-3">
                    <label class="small text-muted fw-bold">Cargo</label>
                    <div>${d.cargo_detalle || '-'}</div>
                    <div class="small">Tipo: ${d.cargo_tipo || '-'} | Nivel: ${d.cargo_nivel || '-'}</div>
                    <div class="small">Depende de: ${d.cargo_depende || '-'}</div>
                </div>
                <div class="mb-3">
                    <label class="small text-muted fw-bold">Fecha Postulación</label>
                    <div>${new Date(d.fechapostulacion).toLocaleString()}</div>
                </div>
            `;

            $('#viewPostContent').html(html);
            $('#btnEditFromView').attr('onclick', `$('#viewPostModal').modal('hide'); editPost(${id});`);
            $('#viewPostModal').modal('show');
        }

        function initFilters() {
            // Init Select2 for form filters
            $('.select2-simple').select2({
                theme: 'bootstrap-5',
                dropdownParent: $('#newPostModal'),
                width: '100%'
            });

            // Main Cargo select
            $('#idCargo').select2({
                theme: 'bootstrap-5',
                dropdownParent: $('#newPostModal'),
                placeholder: "Seleccione cargos..."
            });

            // Events for form filters - Multidirectional
            $('#cF_Nivel, #cF_Depende, #cF_Tipo').on('change', function () {
                const id = this.id;
                if (id === 'cF_Nivel') updateFormFilterOptions('nivel');
                else if (id === 'cF_Depende') updateFormFilterOptions('depende');
                else updateFormFilterOptions('tipo');
            });
        }

        function updateFormFilterOptions(changedFilter) {
            const curNivel = $('#cF_Nivel').val();
            const curDepende = $('#cF_Depende').val();
            const curTipo = $('#cF_Tipo').val();

            // Filter cargos based on all current selections
            let filtered = allCargos;
            if (curNivel) filtered = filtered.filter(c => c.nivel == curNivel);
            if (curDepende) filtered = filtered.filter(c => c.dependede == curDepende);
            if (curTipo) filtered = filtered.filter(c => c.tipo == curTipo);

            // Update all filters except the one that changed
            if (changedFilter !== 'nivel') {
                const niveles = [...new Set(filtered.map(c => c.nivel).filter(Boolean))].sort();
                replaceOptions('#cF_Nivel', niveles, curNivel);
            }

            if (changedFilter !== 'depende') {
                const dependes = [...new Set(filtered.map(c => c.dependede).filter(Boolean))].sort();
                replaceOptions('#cF_Depende', dependes, curDepende);
            }

            if (changedFilter !== 'tipo') {
                const tipos = [...new Set(filtered.map(c => c.tipo).filter(Boolean))].sort();
                replaceOptions('#cF_Tipo', tipos, curTipo);
            }

            updateCargoSelect();
        }

        function replaceOptions(selector, values, selected) {
            const el = $(selector);
            el.empty().append('<option value="">Todos</option>');
            values.forEach(v => {
                const isSelected = v === selected;
                el.append(new Option(v, v, false, isSelected));
            });
        }

        function updateCargoSelect() {
            const nivel = $('#cF_Nivel').val();
            const depende = $('#cF_Depende').val();
            const tipo = $('#cF_Tipo').val();

            let filtered = allCargos.filter(c =>
                (!nivel || c.nivel == nivel) &&
                (!depende || c.dependede == depende) &&
                (!tipo || c.tipo == tipo)
            );

            // Sort
            filtered.sort((a, b) => (a.tipo || '').localeCompare(b.tipo || '') || (a.detalle || '').localeCompare(b.detalle || ''));

            // Rebuild Select2
            const el = $('#idCargo');
            const currentVal = el.val();
            el.empty();
            if (filtered.length === 0) {
                el.append('<option value="">No se encontraron cargos</option>');
            } else {
                el.append('<option value="">Seleccione Cargo...</option>');
                filtered.forEach(c => {
                    const text = `${c.tipo || ''} - ${c.detalle || ''} - ${c.nivel || ''}`;
                    el.append(new Option(text, c.idcargo));
                });
            }
            if (currentVal && filtered.some(c => c.idcargo == currentVal)) {
                el.val(currentVal);
            }
            el.trigger('change.select2'); // update UI
        }

        async function deletePost(id) {
            if (!confirm("¿Está seguro de eliminar esta postulación?")) return;
            const res = await fetchAPI(`/postulaciones/${id}`, { method: 'DELETE' });
            if (res && res.ok) {
                showToast("Eliminado correctamente");
                loadData();
            }
        }
    </script>
</body>

</html>