<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargos - Gestión Candidatos</title>
</head>

<body>

    <div class="container my-5">
        <div class="row mb-4 align-items-center">
            <div class="col">
                <h2 class="fw-bold text-dark"><i class="fas fa-briefcase text-success me-2"></i>Cargos</h2>
                <p class="text-muted">Gestión de estructura y cargos disponibles.</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-success" onclick="openNewCargoModal()">
                    <i class="fas fa-plus me-1"></i> Nuevo Cargo
                </button>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="card shadow-sm mb-4 bg-light border-0">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold text-muted mb-0"><i class="fas fa-filter me-2"></i>Filtros de Búsqueda</h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearFilters()">
                        <i class="fas fa-eraser me-1"></i> Limpiar
                    </button>
                </div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label small">Buscar Texto</label>
                        <input type="text" id="filterSearch" class="form-control" placeholder="Nombre, detalle...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Nivel</label>
                        <select id="filterNivel" class="form-select">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Depende De</label>
                        <select id="filterDepende" class="form-select">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Tipo</label>
                        <select id="filterTipo" class="form-select">
                            <option value="">Todos</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="cargosTable" class="table table-hover align-middle w-100">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Nivel / Estructura</th>
                                <th>Depende De</th>
                                <th>Tipo</th>
                                <th>Detalle / Nombre</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Create/Edit -->
    <div class="modal fade" id="newCargoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Crear Nuevo Cargo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="cargoForm">
                        <div class="mb-3">
                            <label class="form-label">Nivel</label>
                            <input type="text" class="form-control" name="nivel" list="nivelesList" required>
                            <datalist id="nivelesList">
                                <option value="Central">
                                <option value="Regional">
                            </datalist>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Depende De (Área/Jefatura)</label>
                            <input type="text" class="form-control" name="dependeDe">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo</label>
                            <input type="text" class="form-control" name="tipo">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Detalle (Nombre del cargo)</label>
                            <input type="text" class="form-control" name="detalle" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" form="cargoForm" class="btn btn-success">Guardar Cargo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal View Cargo -->
    <div class="modal fade" id="viewCargoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Detalle de Cargo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="viewCargoContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="btnEditFromViewCargo">Editar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        document.addEventListener('libsLoaded', initApp);
        if (window.jQuery) initApp();

        let table;
        let allCargosData = [];
        let currentEditId = null;

        function initApp() {
            if (!isAuthenticated()) { window.location.href = "index.html"; return; }
            renderLayout('cargos');

            // Custom Filtering
            $.fn.dataTable.ext.search.push(
                function (settings, data, dataIndex, rowData) {
                    if (settings.nTable.id !== 'cargosTable') return true;

                    const fNivel = $('#filterNivel').val();
                    const fDepende = $('#filterDepende').val();
                    const fTipo = $('#filterTipo').val();

                    if (!fNivel && !fDepende && !fTipo) return true;

                    if (fNivel && rowData.nivel !== fNivel) return false;
                    if (fDepende && rowData.dependede !== fDepende) return false;
                    if (fTipo && rowData.tipo !== fTipo) return false;

                    return true;
                }
            );

            table = $('#cargosTable').DataTable({
                language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json" },
                order: [[0, "desc"]],
                columns: [
                    { data: "idcargo" },
                    { data: "nivel", render: (d) => `<span class="badge bg-light text-dark border">${d}</span>` },
                    { data: "dependede" },
                    { data: "tipo" },
                    { data: "detalle", className: "fw-bold" },
                    {
                        data: null,
                        orderable: false,
                        render: (d) => `
                            <button class="btn btn-sm btn-outline-info me-1" onclick="viewCargo(${d.idcargo})" title="Ver"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editCargo(${d.idcargo})" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCargo(${d.idcargo})" title="Eliminar"><i class="fas fa-trash"></i></button>
                        `
                    }
                ]
            });

            // Filter events - Bidirectional Cascading
            $('#filterNivel').on('change', function () {
                updateAllFilters('nivel');
                table.draw();
            });
            $('#filterDepende').on('change', function () {
                updateAllFilters('depende');
                table.draw();
            });
            $('#filterTipo').on('change', function () {
                updateAllFilters('tipo');
                table.draw();
            });
            $('#filterSearch').on('keyup', function () {
                table.search(this.value).draw();
            });

            loadData();

            $('#cargoForm').on('submit', async function (e) {
                e.preventDefault();
                const btn = $(this).find('button[type="submit"]');
                btn.prop('disabled', true);

                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());

                let res;
                if (currentEditId) {
                    res = await fetchAPI(`/cargos/${currentEditId}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                } else {
                    res = await fetchAPI('/cargos', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                }

                if (res && res.ok) {
                    showToast(currentEditId ? "Cargo actualizado" : "Cargo creado correctamente");
                    $('#newCargoModal').modal('hide');
                    loadData();
                } else {
                    showToast("Error al guardar cargo", "error");
                }
                btn.prop('disabled', false);
            });
        }

        async function loadData() {
            const res = await fetchAPI('/cargos');
            if (res) {
                const data = await res.json();
                allCargosData = data;
                table.clear().rows.add(data).draw();
                populateFilters(data);
            }
        }

        function populateFilters(data) {
            const niveles = [...new Set(data.map(d => d.nivel).filter(Boolean))].sort();
            fillSelect('#filterNivel', niveles);
            updateAllFilters('init');
        }

        function updateAllFilters(changedFilter) {
            const nivel = $('#filterNivel').val();
            const depende = $('#filterDepende').val();
            const tipo = $('#filterTipo').val();

            // Filter data based on current selections
            let filtered = allCargosData;
            if (nivel) filtered = filtered.filter(d => d.nivel == nivel);
            if (depende) filtered = filtered.filter(d => d.dependede == depende);
            if (tipo) filtered = filtered.filter(d => d.tipo == tipo);

            // Update all dropdowns except the one that changed
            if (changedFilter !== 'nivel') {
                const niveles = [...new Set(filtered.map(d => d.nivel).filter(Boolean))].sort();
                fillSelect('#filterNivel', niveles, nivel);
            }

            if (changedFilter !== 'depende') {
                const dependes = [...new Set(filtered.map(d => d.dependede).filter(Boolean))].sort();
                fillSelect('#filterDepende', dependes, depende);
            }

            if (changedFilter !== 'tipo') {
                const tipos = [...new Set(filtered.map(d => d.tipo).filter(Boolean))].sort();
                fillSelect('#filterTipo', tipos, tipo);
            }
        }

        function fillSelect(selector, values, currentSelection) {
            const el = $(selector);
            const current = currentSelection !== undefined ? currentSelection : el.val();
            el.empty().append('<option value="">Todos</option>');
            values.forEach(v => {
                el.append(new Option(v, v));
            });
            if (current && values.includes(current)) el.val(current);
            else if (current) el.val('');
        }

        function clearFilters() {
            $('#filterSearch').val('');
            $('#filterNivel').val('').trigger('change');
            // Don't manually reset depende/tipo - let cascade handle it
            table.search('').draw();
        }

        function openNewCargoModal() {
            currentEditId = null;
            $('#cargoForm')[0].reset();
            $('#newCargoModal .modal-title').text("Crear Nuevo Cargo");
            $('#newCargoModal button[type="submit"]').text("Guardar Cargo");
            $('#newCargoModal').modal('show');
        }

        function editCargo(id) {
            const c = table.rows().data().toArray().find(r => r.idcargo == id);
            if (!c) return;

            currentEditId = id;
            const f = document.getElementById('cargoForm');
            f.reset();

            $('[name="nivel"]').val(c.nivel);
            $('[name="dependeDe"]').val(c.dependede);
            $('[name="tipo"]').val(c.tipo);
            $('[name="detalle"]').val(c.detalle);

            $('#newCargoModal .modal-title').text("Editar Cargo");
            $('#newCargoModal button[type="submit"]').text("Actualizar Cargo");
            $('#newCargoModal').modal('show');
        }

        function viewCargo(id) {
            const c = table.rows().data().toArray().find(r => r.idcargo == id);
            if (!c) return;

            const html = `
                <p><strong>Nivel:</strong> ${c.nivel}</p>
                <p><strong>Depende De:</strong> ${c.dependede || '-'}</p>
                <p><strong>Tipo:</strong> ${c.tipo || '-'}</p>
                <p><strong>Detalle:</strong> ${c.detalle}</p>
            `;
            $('#viewCargoContent').html(html);
            $('#btnEditFromViewCargo').attr('onclick', `$('#viewCargoModal').modal('hide'); editCargo(${id});`);
            $('#viewCargoModal').modal('show');
        }

        async function deleteCargo(id) {
            if (!confirm("¿Eliminar este cargo?")) return;
            const res = await fetchAPI(`/cargos/${id}`, { method: 'DELETE' });
            if (res && res.ok) {
                showToast("Cargo eliminado");
                loadData();
            }
        }
    </script>
</body>

</html>