<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Gestión de Revisiones</title>
</head>

<body>
    <div class="container">
        <h1>Gestión de Revisiones</h1>

        <div class="card">
            <h3>Nueva Revisión</h3>
            <form id="revForm">
                <label>Seleccionar Postulación:</label>
                <select id="idPostulacion" required>
                    <option value="">Cargando...</option>
                </select>

                <input type="text" id="tipoCandidatura" placeholder="Tipo Candidatura">
                <input type="text" id="prioridad" placeholder="Prioridad">
                <input type="text" id="estado" placeholder="Estado">
                <input type="text" id="fitPolitico" placeholder="Fit Político">
                <textarea id="comentarios" placeholder="Comentarios"></textarea>
                <textarea id="analisisCvIa" placeholder="Análisis IA"></textarea>

                <button type="submit" class="btn">Crear Revisión</button>
            </form>
        </div>

        <div class="card">
            <h3>Listado de Revisiones</h3>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Candidato</th>
                        <th>Estado</th>
                        <th>Prioridad</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        if (!isAuthenticated()) window.location.href = "index.html";
        renderNavbar();

        async function loadPostulaciones() {
            const res = await fetchAPI('/postulaciones');
            if (res) {
                const posts = await res.json();
                const sel = document.getElementById('idPostulacion');
                sel.innerHTML = '<option value="">-- Seleccione Postulación --</option>';
                posts.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.idpostulacion;
                    opt.textContent = `ID ${p.idpostulacion} - ${p.nombres} ${p.apellidopaterno}`;
                    sel.appendChild(opt);
                });
            }
        }

        async function loadRevisiones() {
            const res = await fetchAPI('/revisiones');
            if (!res) return;
            const data = await res.json();
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.idrevision}</td>
                    <td>${item.nombres || ''} (${item.rut})</td>
                    <td>${item.estado || '-'}</td>
                    <td>${item.prioridad || '-'}</td>
                    <td>${new Date(item.fecharevision).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteRev(${item.idrevision})">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('revForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const body = {
                idPostulacion: document.getElementById('idPostulacion').value,
                tipoCandidatura: document.getElementById('tipoCandidatura').value,
                prioridad: document.getElementById('prioridad').value,
                estado: document.getElementById('estado').value,
                fitPolitico: document.getElementById('fitPolitico').value,
                comentarios: document.getElementById('comentarios').value,
                analisisCvIa: document.getElementById('analisisCvIa').value
            };

            const res = await fetchAPI('/revisiones', {
                method: 'POST',
                body: JSON.stringify(body)
            });

            if (res && res.ok) {
                alert("Revisión guardada");
                loadRevisiones();
            } else {
                alert("Error guardando revisión");
            }
        });

        async function deleteRev(id) {
            if (!confirm("¿Seguro?")) return;
            const res = await fetchAPI(`/revisiones/${id}`, { method: 'DELETE' });
            if (res && res.ok) loadRevisiones();
        }

        loadPostulaciones();
        loadRevisiones();
    </script>
</body>

</html>