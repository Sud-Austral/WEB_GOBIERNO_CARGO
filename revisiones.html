<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Revisiones - Gestión Candidatos</title>
</head>

<body>

    <div class="container pb-5">
        <div class="row align-items-center mb-4 page-header">
            <div class="col-md-8">
                <h2 class="fw-bold text-dark mb-1">
                    <i class="fas fa-clipboard-check text-primary me-2"></i>Gestión de Revisiones
                </h2>
                <p class="text-muted mb-0">Evalúe a los candidatos postulados. Cree revisiones para nuevas postulaciones
                    o actualice las existentes.</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-inline-block text-start">
                    <small class="text-muted d-block">Progreso Total</small>
                    <div class="d-flex align-items-center gap-2">
                        <strong class="text-dark" id="progressText">0%</strong>
                        <div class="progress" style="width: 100px; height: 6px;">
                            <div class="progress-bar bg-success" id="progressBar" role="progressbar" style="width: 0%">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-white border-bottom-0 pt-3 pb-0">
                <h6 class="fw-bold text-muted mb-0"><i class="fas fa-filter text-primary me-2"></i>Filtros Avanzados
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Row 1 -->
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted mb-1">Buscar Texto</label>
                        <input type="text" id="filterSearch" class="form-control form-control-sm"
                            placeholder="Nombre, RUT, detalle...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted mb-1">Candidato</label>
                        <select id="filterPersona" class="form-select form-select-sm" style="width: 100%;"></select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted mb-1">Cargo</label>
                        <select id="filterCargo" class="form-select form-select-sm" style="width: 100%;"></select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted mb-1">Estado Revisión</label>
                        <select id="filterEstadoRev" class="form-select form-select-sm fw-bold">
                            <option value="all">Ver Todos</option>
                            <option value="pending" selected>Pendientes de Revisión</option>
                            <option value="reviewed">Ya Revisados</option>
                            <option value="Seleccionado">-- Seleccionado --</option>
                            <option value="Finalista">-- Finalista --</option>
                            <option value="Rechazado">-- Rechazado --</option>
                        </select>
                    </div>

                    <!-- Row 2 -->
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted mb-1">Nivel</label>
                        <select id="filterNivel" class="form-select form-select-sm">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted mb-1">Depende De</label>
                        <select id="filterDepende" class="form-select form-select-sm">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted mb-1">Tipo</label>
                        <select id="filterTipo" class="form-select form-select-sm">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-light btn-sm w-100 border" onclick="resetFilters()">
                            <i class="fas fa-sync-alt text-muted me-1"></i> Limpiar Filtros
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Table Card -->
        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table id="mainTable" class="table table-hover align-middle w-100 mb-0" style="min-width: 1000px;">
                        <thead class="bg-light text-uppercase text-muted small">
                            <tr>
                                <th class="ps-4">Candidato</th>
                                <th>Cargo</th>
                                <th>Detalles Cargo</th>
                                <th>Estado Revisión</th>
                                <th>Prioridad</th>
                                <th class="text-end pe-4">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- JS Generated -->
                        </tbody>
                    </table>
                </div>
                <div id="emptyState" class="text-center py-5 d-none">
                    <i class="fas fa-search fa-3x text-light mb-3"></i>
                    <p class="text-muted">No se encontraron registros con los filtros actuales.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Create/Edit Revision -->
    <div class="modal fade" id="revModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <div>
                        <h5 class="modal-title fw-bold" id="revModalTitle">Evaluación de Candidato</h5>
                        <small class="opacity-75" id="revModalSubtitle">Detalle de postulación</small>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 bg-light bg-opacity-10">
                    <form id="revForm" class="needs-validation" novalidate>
                        <input type="hidden" id="idRevision">
                        <input type="hidden" id="idPostulacion"> <!-- Important -->

                        <!-- Info Resumen (Read Only) -->
                        <div class="card mb-4 border-0 bg-white shadow-sm">
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6 border-end">
                                        <label class="small text-muted fw-bold d-block">Candidato</label>
                                        <div class="d-flex align-items-center mt-1">
                                            <div class="rounded-circle bg-light text-primary d-flex align-items-center justify-content-center me-3 fw-bold"
                                                style="width: 40px; height: 40px; font-size: 0.9rem;" id="modalAvatar">
                                                --
                                            </div>
                                            <div>
                                                <h6 class="mb-0 fw-bold text-dark" id="modalCandidatoName">-</h6>
                                                <small class="text-muted" id="modalCandidatoProf">-</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 ps-md-4">
                                        <label class="small text-muted fw-bold d-block">Cargo Postulado</label>
                                        <h6 class="mb-1 text-dark fw-bold mt-1" id="modalCargo">-</h6>
                                        <span class="badge bg-light text-secondary border" id="modalNivel">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions Row -->
                        <div class="d-flex justify-content-end mb-3">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="btnViewCV">
                                <i class="fas fa-file-pdf me-1"></i> Ver CV / Documentos
                            </button>
                        </div>

                        <!-- Form Evaluacion -->
                        <h6 class="text-primary border-bottom pb-2 mb-3 fw-bold">Evaluación</h6>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">Estado del Proceso</label>
                                <select class="form-select" id="estado" name="estado" required>
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Revisión CV">Revisión CV</option>
                                    <option value="Entrevista">Entrevista</option>
                                    <option value="Prueba Técnica">Prueba Técnica</option>
                                    <option value="Finalista">Finalista</option>
                                    <option value="Seleccionado">Seleccionado</option>
                                    <option value="Rechazado">Rechazado</option>
                                    <option value="Cargo No Disponible">Cargo No Disponible</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">Prioridad / Ranking</label>
                                <select class="form-select" id="prioridad" name="prioridad" required>
                                    <option value="">-- Seleccionar --</option>
                                    <option value="Alta">Alta (Top Candidate)</option>
                                    <option value="Media">Media (Potencial)</option>
                                    <option value="Baja">Baja</option>
                                    <option value="Descartado">Descartado</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">Fit Cultural/Político</label>
                                <select class="form-select" id="fitPolitico" name="fitPolitico">
                                    <option value="">-- Seleccionar --</option>
                                    <option value="Alto">Alto</option>
                                    <option value="Medio">Medio</option>
                                    <option value="Bajo">Bajo</option>
                                    <option value="Nulo">Nulo</option>
                                </select>
                            </div>

                            <div class="col-12 mt-3">
                                <label class="form-label fw-bold small">Análisis / Comentarios</label>
                                <textarea class="form-control" id="comentarios" name="comentarios" rows="4"
                                    placeholder="Ingrese sus observaciones sobre el candidato..."></textarea>
                                <div class="form-text text-muted"><i class="fas fa-magic me-1"></i>Puede usar IA para
                                    analizar el CV si está disponible.</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-white">
                    <button type="button" class="btn btn-light text-muted" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary px-4" onclick="saveRevision()">
                        <i class="fas fa-save me-2"></i>Guardar Evaluación
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Viewer Modal Logic is in common.js but we typically need the HTML container or use the one injected if any.
         personas.html has it. We should include it here too or move to common.js render?
         common.js STYLES defines CSS but layout injection... 
         Let's just adding the modal HTML here to be safe -->
    <div id="pdfViewerModal" class="pdf-viewer-modal">
        <div class="pdf-viewer-header">
            <h5 class="fw-bold mb-0" id="viewerDocName"><i class="fas fa-file-pdf text-danger me-2"></i>Documento</h5>
            <button class="pdf-viewer-close-btn" onclick="closePdfViewer()"><i class="fas fa-times"></i></button>
        </div>
        <div class="pdf-viewer-body">
            <iframe id="pdfFrame" class="pdf-viewer-iframe"></iframe>
        </div>
    </div>

    <!-- View Docs List Modal (Reused logic) -->
    <div class="modal fade" id="viewDocsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Documentos del Candidato</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="docsListBody">
                    Cargando...
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="common.js"></script>
    <script>
        document.addEventListener('libsLoaded', initApp);
        if (window.jQuery && typeof isAuthenticated !== 'undefined' && isAuthenticated()) initApp();

        let allPostulaciones = [];
        let allRevisiones = [];
        let viewData = []; // Combined Data map

        let personasMap = {}; // {id: "Name"}
        let cargosMap = {};   // {id: "Title"}

        async function initApp() {
            if (!isAuthenticated()) { window.location.href = "index.html"; return; }
            renderLayout('revisiones');

            // Init Select2 for Filters
            $('#filterPersona').select2({ placeholder: "Todos los Candidatos", allowClear: true, width: '100%' });
            $('#filterCargo').select2({ placeholder: "Todos los Cargos", allowClear: true, width: '100%' });

            // Listeners
            $('#filterPersona, #filterCargo, #filterEstadoRev, #filterNivel, #filterDepende, #filterTipo').on('change', renderTable);
            $('#filterSearch').on('keyup', renderTable);

            await loadData();

            // Auto-open modal if createFor param exists
            const params = new URLSearchParams(window.location.search);
            const createFor = params.get('createFor');
            if (createFor) {
                // Clear URL
                window.history.replaceState({}, document.title, window.location.pathname);
                // Find postulation and open modal
                // Ideally wait for data load
                setTimeout(() => openForPostulation(createFor), 500);
            }
        }

        async function loadData() {
            try {
                const [resPost, resRev, resPer, resCar] = await Promise.all([
                    fetchAPI('/postulaciones'),
                    fetchAPI('/revisiones'),
                    fetchAPI('/personas'),
                    fetchAPI('/cargos')
                ]);

                if (resPost && resRev) {
                    allPostulaciones = await resPost.json();
                    allRevisiones = await resRev.json();
                    const personas = await resPer.json();
                    const cargos = await resCar.json();

                    // Maps for fast lookup
                    personas.forEach(p => personasMap[p.idpersona] = `${p.nombres} ${p.apellidopaterno}`);
                    cargos.forEach(c => cargosMap[c.idcargo] = c.detalle);

                    // Set Global for processData enrichment
                    window.allCargos = cargos;
                    window.allPersonas = personas;

                    // Fill Filters
                    fillSelect2('#filterPersona', personas.map(p => ({ id: p.idpersona, text: `${p.nombres} ${p.apellidopaterno} (${p.rut})` })));
                    populateExtendedFilters(cargos);

                    processData();
                    renderTable();
                    updateStats();
                }
            } catch (e) {
                console.error(e);
                showToast("Error cargando datos", "error");
            }
        }

        function fillSelect2(selector, data) {
            const sel = $(selector);
            sel.empty();
            sel.append(new Option('', '')); // Empty for placeholder
            data.forEach(item => {
                sel.append(new Option(item.text, item.id));
            });
        }

        function populateExtendedFilters(cargos) {
            // Cargo Select2
            const cbCargo = $('#filterCargo');
            cbCargo.empty().append(new Option('', ''));
            cargos.forEach(c => cbCargo.append(new Option(`${c.detalle} (${c.nivel})`, c.idcargo)));

            const fill = (id, field) => {
                // Try both casings just in case
                const vals = [...new Set(cargos.map(c => c[field] || c[field.toLowerCase()]).filter(Boolean))].sort();
                const el = $(id);
                el.empty().append('<option value="">Todos</option>');
                vals.forEach(v => el.append(new Option(v, v)));
            };

            fill('#filterNivel', 'nivel');
            fill('#filterDepende', 'dependeDe');
            fill('#filterTipo', 'tipo');
        }

        // Wrapper for compatibility
        function filterCargos(cargos) {
            populateExtendedFilters(cargos);
        }

        function processData() {
            viewData = allPostulaciones.map(p => {
                const rev = allRevisiones.find(r => r.idpostulacion == p.idpostulacion);
                // Access global allCargos
                const cargo = (window.allCargos || []).find(c => c.idcargo == p.idcargo) || {};
                // Access global allPersonas for fallback info (RUT)
                const per = (window.allPersonas || []).find(pe => pe.idpersona == p.idpersona) || {};

                return {
                    postulacion: p,
                    revision: rev || null,
                    cargo: cargo,
                    personaName: p.nombres + ' ' + p.apellidopaterno,
                    rut: p.rut || per.rut || 'Sin RUT'
                };
            });
        }

        function resetFilters() {
            $('#filterSearch').val('');
            $('#filterPersona').val(null).trigger('change');
            $('#filterCargo').val(null).trigger('change');
            $('#filterEstadoRev').val('pending');
            $('#filterNivel').val('');
            $('#filterDepende').val('');
            $('#filterTipo').val('');
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const empty = document.getElementById('emptyState');
            tbody.innerHTML = '';

            // Get Values
            const fTxt = ($('#filterSearch').val() || '').toLowerCase();
            const fPer = $('#filterPersona').val();
            const fCar = $('#filterCargo').val();
            const fEst = $('#filterEstadoRev').val();
            const fNiv = $('#filterNivel').val();
            const fDep = $('#filterDepende').val();
            const fTip = $('#filterTipo').val();

            // Filter Logic
            const filtered = viewData.filter(item => {
                const p = item.postulacion;
                const r = item.revision;
                const c = item.cargo;

                // 1. Text Search
                if (fTxt) {
                    const searchStr = `${item.personaName} ${item.rut} ${c.detalle || ''}`.toLowerCase();
                    if (!searchStr.includes(fTxt)) return false;
                }

                // 2. Exact Match Filters
                if (fPer && p.idpersona != fPer) return false;
                if (fCar && p.idcargo != fCar) return false;

                // 3. Status Filter (Complex)
                if (fEst === 'pending' && r) return false;
                if (fEst === 'reviewed' && !r) return false;
                // Specific statuses (check specific values if selected from dropdown)
                if (['Seleccionado', 'Finalista', 'Rechazado'].includes(fEst)) {
                    if (!r || r.estado !== fEst) return false;
                }

                // 4. Cargo Attributes
                if (fNiv && c.nivel != fNiv) return false;
                if (fDep && (c.dependeDe || c.dependede) != fDep) return false; // Handle casing
                if (fTip && c.tipo != fTip) return false;

                return true;
            });

            if (filtered.length === 0) {
                tbody.closest('table').classList.add('d-none');
                empty.classList.remove('d-none');
                return;
            } else {
                tbody.closest('table').classList.remove('d-none');
                empty.classList.add('d-none');
            }

            filtered.forEach(item => {
                const p = item.postulacion;
                const r = item.revision;
                const c = item.cargo;

                // Detailed Person Info (Calculate Age, etc)
                const per = (window.allPersonas || []).find(pf => pf.idpersona == p.idpersona) || {};
                let edadStr = '';
                if (per.fechanacimiento) {
                    const diff = Date.now() - new Date(per.fechanacimiento).getTime();
                    const ageDate = new Date(diff);
                    const years = Math.abs(ageDate.getUTCFullYear() - 1970);
                    edadStr = `${years} años`;
                }
                const extraInfo = [
                    per.profesion || '',
                    edadStr,
                    per.genero || per.sexo || ''
                ].filter(Boolean).join(' • '); // Bullet separator looks cleaner

                const initials = (p.nombres[0] + (p.apellidopaterno ? p.apellidopaterno[0] : '')).toUpperCase();

                const tr = document.createElement('tr');

                // Status Badge logic...
                let statusBadge = '<span class="badge bg-light text-muted border">Pendiente</span>';
                if (r) {
                    let color = 'bg-secondary';
                    if (r.estado === 'Seleccionado') color = 'bg-success';
                    if (r.estado === 'Rechazado') color = 'bg-danger';
                    if (r.estado === 'Entrevista') color = 'bg-primary';
                    if (r.estado === 'Finalista') color = 'bg-info text-dark';
                    statusBadge = `<span class="badge ${color}">${r.estado}</span>`;
                }

                // Priority logic...
                let prio = '-';
                if (r && r.prioridad) {
                    let icon = 'minus';
                    let col = 'text-muted';
                    if (r.prioridad === 'Alta') { icon = 'arrow-up'; col = 'text-success'; }
                    if (r.prioridad === 'Baja') { icon = 'arrow-down'; col = 'text-danger'; }
                    prio = `<span class="${col} fw-bold small"><i class="fas fa-${icon} me-1"></i>${r.prioridad}</span>`;
                }

                // Action Button logic...
                let actionBtn;
                if (r) {
                    actionBtn = `
                        <button class="btn btn-outline-secondary btn-sm" onclick="openEditModal(${r.idrevision})" title="Ver/Editar Evaluación">
                            <i class="fas fa-edit text-primary"></i> <span class="d-none d-md-inline ms-1">Editar</span>
                        </button>
                    `;
                } else {
                    actionBtn = `
                        <button class="btn btn-primary btn-sm shadow-sm" onclick="openForPostulation(${p.idpostulacion})" title="Crear Evaluación">
                            <i class="fas fa-play me-1"></i> Evaluar
                        </button>
                    `;
                }

                // Combine Nivel/Tipo for details column
                const details = `
                    <span class="badge bg-light text-dark border me-1">${c.nivel || '-'}</span>
                    <small class="text-muted">${c.tipo || ''}</small>
                `;
                console.log(item);
                tr.innerHTML = `
                    <td class="ps-4">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center me-3 fw-bold" 
                                 style="width: 38px; height: 38px; font-size: 0.85rem;">
                                ${initials}
                            </div>
                            <div>
                                <div class="fw-bold text-dark lh-sm">${item.personaName}</div>
                                
                                <div class="small text-muted mt-1 fst-italic opacity-75" style="font-size: 0.75rem;">${extraInfo}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="fw-bold text-dark small">${c.detalle || 'Cargo'}</div>
                         <div class="text-xs text-muted">Dep: ${c.dependeDe || c.dependede || '-'}</div>
                    </td>
                    <td>${details}</td>
                    <td>${statusBadge}</td>
                    <td>${prio}</td>
                    <td class="text-end pe-4">
                        ${actionBtn}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateStats() {
            const total = viewData.length;
            const reviewed = viewData.filter(i => i.revision).length;
            const percent = total === 0 ? 0 : Math.round((reviewed / total) * 100);

            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${percent}%`;
        }

        // --- User Actions ---

        function openForPostulation(postID) {
            // New Revision
            const item = viewData.find(i => i.postulacion.idpostulacion == postID);
            if (!item) return;

            if (item.revision) {
                // If it already has one (e.g. race condition), edit it
                openEditModal(item.revision.idrevision);
                return;
            }

            prepModal(item.postulacion, null);
        }

        function openEditModal(revID) {
            const rev = allRevisiones.find(r => r.idrevision == revID);
            if (!rev) return;
            // Find parent postulacion
            const post = allPostulaciones.find(p => p.idpostulacion == rev.idpostulacion);
            prepModal(post, rev);
        }

        function prepModal(postulacion, revision) {
            const form = document.getElementById('revForm');
            form.reset();
            form.classList.remove('was-validated');

            // Header Info
            const p = postulacion;
            const initials = (p.nombres[0] + (p.apellidopaterno ? p.apellidopaterno[0] : '')).toUpperCase();

            document.getElementById('modalAvatar').textContent = initials;
            document.getElementById('modalCandidatoName').textContent = `${p.nombres} ${p.apellidopaterno}`;
            document.getElementById('modalCandidatoProf').textContent = p.profesion || 'Sin profesión registrada';

            document.getElementById('modalCargo').textContent = p.detalle || p.cargo_detalle;
            document.getElementById('modalNivel').textContent = p.nivel || p.cargo_nivel; // If API provides

            // Set IDs
            document.getElementById('idPostulacion').value = p.idpostulacion;

            // Setup "Ver CV" button
            document.getElementById('btnViewCV').onclick = () => showDocsModal(p.idpersona);

            if (revision) {
                // Edit Mode
                document.getElementById('revModalTitle').textContent = "Editar Evaluación";
                document.getElementById('idRevision').value = revision.idrevision;

                $('#estado').val(revision.estado);
                $('#prioridad').val(revision.prioridad);
                $('#fitPolitico').val(revision.fitpolitico); // Check casing from API lower/camel
                $('#comentarios').val(revision.comentarios);
            } else {
                // Create Mode
                document.getElementById('revModalTitle').textContent = "Nueva Evaluación";
                document.getElementById('idRevision').value = "";
                $('#estado').val("Pendiente"); // Default
            }

            $('#revModal').modal('show');
        }

        async function saveRevision() {
            const form = document.getElementById('revForm');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            const idRev = document.getElementById('idRevision').value;
            const idPost = document.getElementById('idPostulacion').value;

            const payload = {
                idPostulacion: idPost,
                estado: $('#estado').val(),
                prioridad: $('#prioridad').val(),
                fitPolitico: $('#fitPolitico').val(),
                comentarios: $('#comentarios').val()
                // analisisCvIa: ... (Not implemented in UI yet)
            };

            const btn = document.querySelector('#revModal .modal-footer .btn-primary');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            try {
                const url = idRev ? `/revisiones/${idRev}` : '/revisiones';
                const method = idRev ? 'PUT' : 'POST';

                const res = await fetchAPI(url, {
                    method: method,
                    body: JSON.stringify(payload)
                });

                if (res && res.ok) {
                    showToast("Evaluación guardada exitosamente");
                    $('#revModal').modal('hide');
                    loadData(); // Reload table
                } else {
                    showToast("Error al guardar", "error");
                }
            } catch (err) {
                console.error(err);
                showToast("Error de conexión", "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- Docs Viewer Helpers ---
        async function showDocsModal(personaId) {
            const listBody = document.getElementById('docsListBody');
            listBody.innerHTML = '<div class="text-center my-3"><i class="fas fa-spinner fa-spin text-primary"></i> Cargando...</div>';
            new bootstrap.Modal(document.getElementById('viewDocsModal')).show();

            try {
                const res = await fetchAPI(`/personas/${personaId}/documentos`);
                if (res && res.ok) {
                    const docs = await res.json();
                    if (docs.length === 0) {
                        listBody.innerHTML = '<div class="alert alert-warning">No hay documentos adjuntos.</div>';
                        return;
                    }

                    let html = '<div class="list-group list-group-flush">';
                    docs.forEach(d => {
                        html += `
                            <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-1 border rounded" 
                                onclick="openPdfViewer(${d.documento_id}, '${d.nombre}')">
                                <div>
                                    <i class="fas fa-file-pdf text-danger me-2"></i>
                                    <strong>${d.nombre || d.archivo_nombre}</strong>
                                </div>
                                <span class="badge bg-light text-dark border">Ver</span>
                            </button>
                         `;
                    });
                    html += '</div>';
                    listBody.innerHTML = html;
                }
            } catch (e) {
                listBody.innerHTML = '<p class="text-danger">Error cargando documentos.</p>';
            }
        }

        // Reuse PDF logic from common if possible, but here we implemented local HTML container.
        // We need the JS functions for openPdfViewer (which fetches blob).
        // Common.js doesn't have openPdfViewer logic, it was in personas.html.
        // I will copy a minimal version here.
        async function openPdfViewer(docId, name) {
            const viewer = document.getElementById('pdfViewerModal');
            const frame = document.getElementById('pdfFrame');
            const headerName = document.getElementById('viewerDocName');

            // Assuming view_documento API returns binary
            // Since we upgraded personas.html to use blobs...
            // Let's use the API endpoint that returns file: /documentos/<id>/view
            // We can just set iframe src to that endpoint if we use a token ??
            // Using fetch with Blob is safer for Auth headers.

            viewer.classList.add('active');

            try {
                const res = await fetchAPI(`/documentos/${docId}/view`, {}, false); // binary response handled by fetchAPI? 
                // Wait, fetchAPI wrapper expects JSON usually or returns Response object.
                // fetchAPI returns Response object if OK.

                if (res && res.ok) {
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    frame.src = url;
                }
            } catch (e) {
                console.error(e);
            }
        }
        function closePdfViewer() {
            document.getElementById('pdfViewerModal').classList.remove('active');
            document.getElementById('pdfFrame').src = '';
        }

    </script>
</body>

</html>