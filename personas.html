<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personas - Gestión Candidatos</title>
    <style>
        /* Visor Modal Styles */
        .viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .viewer-modal.active {
            display: flex;
        }

        .viewer-content {
            background: white;
            border-radius: 8px;
            width: 95%;
            max-width: 1200px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .viewer-title {
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .viewer-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .viewer-close:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .viewer-body {
            flex: 1;
            position: relative;
            background: #374151;
        }

        .viewer-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .viewer-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
        }
    </style>
</head>

<body>

    <div class="container my-5">
        <div class="row mb-4 align-items-center">
            <div class="col">
                <h2 class="fw-bold text-dark"><i class="fas fa-users text-primary me-2"></i>Personas</h2>
                <p class="text-muted">Base de datos de todos los candidatos registrados.</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newPersonaModal">
                    <i class="fas fa-plus me-1"></i> Nueva Persona
                </button>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="personasTable" class="table table-hover align-middle w-100">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>RUT</th>
                                <th>Nombre Completo</th>
                                <th>Correo</th>
                                <th>Teléfono</th>
                                <th>Región</th>
                                <th>Profesión</th>
                                <th>Partido</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Create -->
    <div class="modal fade" id="newPersonaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Registrar Nueva Persona</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="personaForm" class="row g-3" novalidate>

                        <!-- Identificación -->
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">Identificación</h6>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">RUT <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="rutInput" name="rut" placeholder="12.345.678-9"
                                required>
                            <div class="invalid-feedback" id="rutError">RUT inválido</div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Nombres <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="nombres" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Apellido Paterno <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="apellidoPaterno" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Apellido Materno</label>
                            <input type="text" class="form-control" name="apellidoMaterno">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Fecha Nacimiento</label>
                            <input type="date" class="form-control" name="fechaNacimiento">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Género</label>
                            <select class="form-select" name="genero">
                                <option value="">-- Seleccionar --</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Femenino">Femenino</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Nacionalidad</label>
                            <input type="text" class="form-control" name="nacionalidad" value="Chilena">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Región Residencia</label>
                            <input type="text" class="form-control" name="regionResidencia">
                        </div>

                        <!-- Contacto y Perfil -->
                        <div class="col-12 mt-4">
                            <h6 class="text-primary border-bottom pb-2">Contacto y Perfil</h6>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Correo Electrónico</label>
                            <input type="email" class="form-control" name="correoElectronico">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Teléfono Celular</label>
                            <input type="text" class="form-control" name="telefonoCelular">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Partido Político</label>
                            <input type="text" class="form-control" name="partidoPolitico">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Profesión <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="profesion" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Grado Académico</label>
                            <input type="text" class="form-control" name="gradoAcademico">
                        </div>

                        <!-- Antecedentes -->
                        <div class="col-12 mt-4">
                            <h6 class="text-primary border-bottom pb-2">Antecedentes y Referencias</h6>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Antecedentes</label>
                            <textarea class="form-control" name="antecedentes" rows="3"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Referencias</label>
                            <textarea class="form-control" name="referencias" rows="3"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observaciones</label>
                            <textarea class="form-control" name="observaciones" rows="2"></textarea>
                        </div>

                        <hr class="my-3">

                        <div class="col-12">
                            <input type="file" class="form-control" id="cvFile" name="cvFile" accept=".pdf" required>
                            <div class="form-text">Solo se permiten archivos PDF.</div>
                        </div>

                        <!-- Postulación Inmediata (Opcional) -->
                        <div class="col-12 mt-4" id="quickPostulationSection">
                            <h6 class="text-success border-bottom pb-2"><i class="fas fa-rocket me-2"></i>Postulación
                                Inmediata (Opcional)</h6>
                            <div class="alert alert-light border small text-muted mb-2">
                                <i class="fas fa-info-circle me-1"></i> Filtre y seleccione uno o más cargos para crear
                                las postulaciones automáticamente.
                            </div>

                            <!-- Filtros Rápidos -->
                            <div class="row g-2 mb-2">
                                <div class="col-md-4">
                                    <label class="form-label small">Filtrar por Nivel</label>
                                    <select class="form-select form-select-sm" id="quickNivel">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Filtrar por Dependencia</label>
                                    <select class="form-select form-select-sm" id="quickDepende">
                                        <option value="">Todas</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Filtrar por Tipo</label>
                                    <select class="form-select form-select-sm" id="quickTipo">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                            </div>

                            <label class="form-label">Postular a Cargo(s):</label>
                            <select class="form-select" id="autoPostulaciones" multiple style="width: 100%;">
                                <!-- Loaded via JS -->
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" form="personaForm" class="btn btn-primary">Guardar Registro</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal View Persona Details -->
    <div class="modal fade" id="viewPersonaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Detalles de la Persona</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3" id="viewPersonaContent">
                        <!-- Content injected via JS -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="btnEditFromView">Editar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal View Documents List -->
    <div class="modal fade" id="viewDocsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold"><i class="fas fa-file-pdf text-danger me-2"></i>Documentos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="docsList">Cargando...</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div id="pdfViewerModal" class="viewer-modal">
        <div class="viewer-content">
            <div class="viewer-header">
                <div class="viewer-title">
                    <i class="fas fa-file-pdf text-danger"></i>
                    <span id="viewerDocName">Documento</span>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="downloadCurrentDoc()">
                        <i class="fas fa-download"></i> Descargar
                    </button>
                    <button class="viewer-close" onclick="closePdfViewer()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="viewer-body">
                <div id="viewerLoading" class="viewer-loading">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Cargando documento...</p>
                </div>
                <iframe id="pdfFrame" class="viewer-iframe"></iframe>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        document.addEventListener('libsLoaded', initApp);
        if (window.jQuery && $.fn && $.fn.DataTable) initApp();

        let table;
        let currentBlobUrl = null;
        let currentDocId = null;
        let currentDocName = null;
        let currentEditId = null;

        // Validación de RUT chileno (Módulo 11)
        function validarRut(rutCompleto) {
            if (!rutCompleto || rutCompleto.length < 3) return false;

            // Limpiar RUT
            let rut = rutCompleto.replace(/\./g, '').replace(/-/g, '').toUpperCase();

            // Separar cuerpo y dígito verificador
            let cuerpo = rut.slice(0, -1);
            let dv = rut.slice(-1);

            // Validar que el cuerpo sea numérico
            if (!/^\d+$/.test(cuerpo)) return false;

            // Calcular dígito verificador
            let suma = 0;
            let multiplo = 2;

            for (let i = cuerpo.length - 1; i >= 0; i--) {
                suma += parseInt(cuerpo[i]) * multiplo;
                multiplo = multiplo === 7 ? 2 : multiplo + 1;
            }

            let resto = suma % 11;
            let dvCalculado = 11 - resto;

            let dvEsperado;
            if (dvCalculado === 11) dvEsperado = '0';
            else if (dvCalculado === 10) dvEsperado = 'K';
            else dvEsperado = dvCalculado.toString();

            return dv === dvEsperado;
        }

        function initApp() {
            if (!isAuthenticated()) { window.location.href = "index.html"; return; }
            renderLayout('personas');

            table = $('#personasTable').DataTable({
                language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json" },
                order: [[0, "desc"]],
                columns: [
                    { data: "idpersona" },
                    { data: "rut" },
                    { data: null, render: (d) => `<b>${d.nombres}</b> ${d.apellidopaterno || ''} ${d.apellidomaterno || ''}` },
                    { data: "correoelectronico" },
                    { data: "telefonocelular" },
                    { data: "regionresidencia" },
                    { data: "profesion" },
                    { data: "partidopolitico", defaultContent: "-" },
                    {
                        data: null,
                        orderable: false,
                        width: "150px",
                        render: (d) => `
                            <button class="btn btn-sm btn-outline-info me-1" onclick="viewPersona(${d.idpersona})" title="Ver Detalles"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editPersona(${d.idpersona})" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="viewDocs(${d.idpersona})" title="Ver Docs"><i class="fas fa-file-pdf"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePersona(${d.idpersona})" title="Eliminar"><i class="fas fa-trash"></i></button>
                        `
                    }
                ]
            });

            loadData();
            initSelect2();

            // New Persona Button hook to reset form state
            $('[data-bs-target="#newPersonaModal"]').on('click', function () {
                openNewPersonaModal();
            });

            // Format RUT on input
            $('#rutInput').on('input', function () {
                let value = this.value.replace(/[^0-9kK]/g, '').toUpperCase();
                if (value.length > 1) {
                    value = value.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, '.') + '-' + value.slice(-1);
                }
                this.value = value;
            });

            $('#personaForm').on('submit', async function (e) {
                e.preventDefault();

                // Reset validation states
                this.classList.remove('was-validated');
                $('#rutInput').removeClass('is-invalid');

                const btn = $(this).find('button[type="submit"]');

                // Validate RUT
                const rutInput = document.getElementById('rutInput');
                if (!validarRut(rutInput.value)) {
                    rutInput.classList.add('is-invalid');
                    document.getElementById('rutError').textContent = 'RUT chileno inválido';
                    showToast("Por favor ingrese un RUT válido", "error");
                    return;
                }

                // Check HTML5 validation
                if (!this.checkValidity()) {
                    this.classList.add('was-validated');
                    showToast("Complete todos los campos obligatorios", "error");
                    return;
                }

                btn.prop('disabled', true);
                btn.html('<i class="fas fa-spinner fa-spin"></i> Guardando...');

                try {
                    const url = currentEditId ? `/personas/${currentEditId}` : '/personas';
                    const method = currentEditId ? 'PUT' : 'POST';

                    // 1. SAVE PERSONA DATA FIRST
                    const formData = new FormData(this); // Get form data
                    const payload = Object.fromEntries(formData.entries());
                    delete payload.cvFile; // Don't send file in JSON

                    // Cleanup empty fields
                    Object.keys(payload).forEach(k => !payload[k] && delete payload[k]);

                    const res = await fetchAPI(url, {
                        method: method,
                        body: JSON.stringify(payload)
                    });

                    if (res && res.ok) {
                        const responseData = await res.json();
                        // Get Persona ID (from response on create, or currentEditId on update)
                        // Backend usually returns {id: X, message: ...} on create
                        // On update it might just return message. use currentEditId.
                        const personaId = currentEditId || responseData.id;

                        // 2. UPLOAD FILE IF PRESENT
                        const cvFile = formData.get('cvFile'); // Get the file object from FormData
                        if (cvFile && cvFile.size > 0 && personaId) { // Check if file exists and is not empty
                            const uploadData = new FormData();
                            uploadData.append('archivo', cvFile);
                            uploadData.append('tipo_documento', 'CV');
                            uploadData.append('nombre', 'Curriculum Vitae');

                            // Use correct endpoint
                            const uploadRes = await fetchAPI(`/personas/${personaId}/documentos`, {
                                method: 'POST',
                                body: uploadData
                            }, true); // isFileUpload=true

                            if (!uploadRes || !uploadRes.ok) {
                                showToast("Persona guardada pero falló la carga del CV", "warning");
                            }
                        }

                        // 3. AUTO-POSTULATION LOGIC (Only on Create)
                        const selectedCargos = $('#autoPostulaciones').val();
                        if (!currentEditId && selectedCargos && selectedCargos.length > 0 && personaId) {
                            let successCount = 0;
                            // Create promises for parallel execution to be faster
                            const promises = selectedCargos.map(cargoId =>
                                fetchAPI('/postulaciones', {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        idPersona: personaId,
                                        idCargo: cargoId
                                    })
                                }).then(r => r.ok ? 1 : 0).catch(() => 0)
                            );

                            const results = await Promise.all(promises);
                            successCount = results.reduce((a, b) => a + b, 0);

                            showToast(`Persona creada y postulada a ${successCount} cargos.`);
                        } else {
                            showToast(currentEditId ? "Registro actualizado" : "Registro creado exitosamente");
                        }

                        $('#newPersonaModal').modal('hide');
                        loadData();
                    } else {
                        throw new Error("Error al guardar datos de la persona");
                    }
                } catch (error) {
                    console.error(error);
                    showToast(error.message || "Error al procesar solicitud", "error");
                } finally {
                    btn.prop('disabled', false);
                    btn.html(currentEditId ? 'Actualizar' : 'Guardar Registro');
                }
            });


            // Close viewer on click outside
            document.getElementById('pdfViewerModal').addEventListener('click', function (e) {
                if (e.target === this) closePdfViewer();
            });
        }

        let cachedCargos = [];

        async function loadData() {
            const res = await fetchAPI('/personas');
            if (res) {
                const data = await res.json();
                table.clear().rows.add(data).draw();
            }

            // Load Cargos for Auto-Postulation
            const resC = await fetchAPI('/cargos');
            if (resC) {
                cachedCargos = await resC.json();
                populateQuickFilters();
                filterAutoPostulaciones(); // Initial fill
            }
        }

        function populateQuickFilters() {
            // Extract unique values
            const niveles = [...new Set(cachedCargos.map(c => c.nivel).filter(Boolean))].sort();
            const dependes = [...new Set(cachedCargos.map(c => c.dependede || c.dependeDe).filter(Boolean))].sort();
            const tipos = [...new Set(cachedCargos.map(c => c.tipo).filter(Boolean))].sort();

            fillSelect('#quickNivel', niveles);
            fillSelect('#quickDepende', dependes);
            fillSelect('#quickTipo', tipos);
        }

        function fillSelect(id, values) {
            const el = $(id);
            el.empty().append('<option value="">Todos</option>');
            values.forEach(v => el.append(new Option(v, v)));
        }

        function filterAutoPostulaciones() {
            const fNivel = $('#quickNivel').val();
            const fDepende = $('#quickDepende').val();
            const fTipo = $('#quickTipo').val();

            const sel = $('#autoPostulaciones');
            // 1. Capture current selection (IDs)
            const currentVal = sel.val() || [];
            const currentValSet = new Set(currentVal.map(String)); // Convert to string for consistent comparison

            const filteredAndSelected = cachedCargos.filter(c => {
                const dep = c.dependede || c.dependeDe;
                const matches = (!fNivel || c.nivel == fNivel) &&
                    (!fDepende || dep == fDepende) &&
                    (!fTipo || c.tipo == fTipo);

                // CRITICAL: Keep item if it matches filter OR if it is already selected
                return matches || currentValSet.has(String(c.idcargo));
            });

            sel.empty();
            filteredAndSelected.forEach(c => {
                sel.append(new Option(`${c.detalle} (${c.nivel})`, c.idcargo));
            });

            // 2. Restore selection (now the options exist, so this will work)
            sel.val(currentVal).trigger('change');
        }

        function initSelect2() {
            // Init Multi-select for cargos inside modal
            $('#autoPostulaciones').select2({
                theme: 'bootstrap-5',
                dropdownParent: $('#newPersonaModal .modal-body'), // Fix positioning
                placeholder: "Seleccione cargos...",
                width: '100%',
                closeOnSelect: false
            });

            // Filter Listeners
            $('#quickNivel, #quickDepende, #quickTipo').on('change', filterAutoPostulaciones);
        }

        function openNewPersonaModal() {
            currentEditId = null;
            $('#personaForm')[0].reset();
            $('#personaForm').removeClass('was-validated');
            $('#rutInput').removeClass('is-invalid');
            $('#rutInput').prop('readonly', false);

            // Reset Auto-Postulation
            $('#autoPostulaciones').val(null).trigger('change');
            $('#quickPostulationSection').show(); // Show on create

            // Reset File info logic if needed (clear custom text)
            // ...
            $('#newPersonaModal').modal('show');
        }

        function openNewPersonaModal() {
            currentEditId = null;
            $('#personaForm')[0].reset();
            $('#personaForm').removeClass('was-validated');
            // Reset modal title and button
            $('#newPersonaModal .modal-title').text("Registrar Nueva Persona");
            $('#newPersonaModal button[type="submit"]').text("Guardar Registro");
            // Make CV required for new
            $('#cvFile').prop('required', true).prev('label').html('<i class="fas fa-file-pdf text-danger me-2"></i>Curriculum Vitae (PDF) *');
            $('#newPersonaModal').modal('show');
        }

        function editPersona(id) {
            const p = table.rows().data().toArray().find(r => r.idpersona == id);
            if (!p) return;

            currentEditId = id;

            // Populate Form
            const f = document.getElementById('personaForm');
            f.reset();
            $('[name="rut"]').val(p.rut);
            $('[name="nombres"]').val(p.nombres);
            $('[name="apellidoPaterno"]').val(p.apellidopaterno || p.apellidoPaterno);
            $('[name="apellidoMaterno"]').val(p.apellidomaterno || p.apellidoMaterno);
            // Date format YYYY-MM-DD
            if (p.fechanacimiento) {
                const d = new Date(p.fechanacimiento);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                $('[name="fechaNacimiento"]').val(`${yyyy}-${mm}-${dd}`);
            }

            $('[name="genero"]').val(p.genero);
            $('[name="nacionalidad"]').val(p.nacionalidad);
            $('[name="regionResidencia"]').val(p.regionresidencia || p.regionResidencia);
            $('[name="correoElectronico"]').val(p.correoelectronico || p.correoElectronico);
            $('[name="telefonoCelular"]').val(p.telefonocelular || p.telefonoCelular);
            $('[name="partidoPolitico"]').val(p.partidopolitico || p.partidoPolitico);
            $('[name="profesion"]').val(p.profesion);
            $('[name="gradoAcademico"]').val(p.gradoacademico || p.gradoAcademico);
            $('[name="antecedentes"]').val(p.antecedentes);
            $('[name="referencias"]').val(p.referencias);
            $('[name="observaciones"]').val(p.observaciones);

            // Change Modal Title and Button
            $('#newPersonaModal .modal-title').text("Editar Persona");
            $('#newPersonaModal button[type="submit"]').text("Actualizar");

            // CV is optional on edit
            $('#cvFile').prop('required', false).prev('label').html('<i class="fas fa-file-pdf text-danger me-2"></i>Actualizar CV (Opcional)');

            $('#newPersonaModal').modal('show');
        }

        function viewPersona(id) {
            const p = table.rows().data().toArray().find(r => r.idpersona == id);
            if (!p) return;

            const html = `
                <div class="col-md-4"><label class="fw-bold small text-muted">RUT</label><p>${p.rut}</p></div>
                <div class="col-md-8"><label class="fw-bold small text-muted">Nombre Completo</label><p>${p.nombres} ${p.apellidopaterno} ${p.apellidomaterno || ''}</p></div>
                
                <div class="col-md-4"><label class="fw-bold small text-muted">Fecha Nacimiento</label><p>${p.fechanacimiento ? new Date(p.fechanacimiento).toLocaleDateString() : '-'}</p></div>
                <div class="col-md-4"><label class="fw-bold small text-muted">Género</label><p>${p.genero || '-'}</p></div>
                <div class="col-md-4"><label class="fw-bold small text-muted">Nacionalidad</label><p>${p.nacionalidad || '-'}</p></div>
                
                <div class="col-md-4"><label class="fw-bold small text-muted">Correo</label><p>${p.correoelectronico || '-'}</p></div>
                <div class="col-md-4"><label class="fw-bold small text-muted">Teléfono</label><p>${p.telefonocelular || '-'}</p></div>
                <div class="col-md-4"><label class="fw-bold small text-muted">Región</label><p>${p.regionresidencia || '-'}</p></div>
                
                <div class="col-md-4"><label class="fw-bold small text-muted">Profesión</label><p>${p.profesion || '-'}</p></div>
                <div class="col-md-4"><label class="fw-bold small text-muted">Grado Académico</label><p>${p.gradoacademico || '-'}</p></div>
                <div class="col-md-4"><label class="fw-bold small text-muted">Partido Político</label><p>${p.partidopolitico || '-'}</p></div>
                
                <div class="col-12"><label class="fw-bold small text-muted">Antecedentes</label><p class="bg-light p-2 rounded">${p.antecedentes || 'Sin antecedentes'}</p></div>
                <div class="col-12"><label class="fw-bold small text-muted">Referencias</label><p class="bg-light p-2 rounded">${p.referencias || 'Sin referencias'}</p></div>
                <div class="col-12"><label class="fw-bold small text-muted">Observaciones</label><p class="bg-light p-2 rounded">${p.observaciones || 'Sin observaciones'}</p></div>
            `;

            $('#viewPersonaContent').html(html);
            $('#btnEditFromView').attr('onclick', `$('#viewPersonaModal').modal('hide'); editPersona(${id});`);
            $('#viewPersonaModal').modal('show');
        }

        async function deletePersona(id) {
            if (!confirm("¿Eliminar este registro? Esta acción es irreversible.")) return;
            const res = await fetchAPI(`/personas/${id}`, { method: 'DELETE' });
            if (res && res.ok) {
                showToast("Registro eliminado");
                loadData();
            }
        }

        async function viewDocs(personaId) {
            const docsList = document.getElementById('docsList');
            docsList.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>';

            $('#viewDocsModal').modal('show');

            const res = await fetchAPI(`/personas/${personaId}/documentos`);
            if (res && res.ok) {
                const docs = await res.json();

                if (docs.length === 0) {
                    docsList.innerHTML = '<div class="alert alert-info mb-0">Esta persona no tiene documentos.</div>';
                    return;
                }

                let html = '<ul class="list-group">';
                docs.forEach(doc => {
                    const sizeKb = doc.archivo_size ? Math.round(doc.archivo_size / 1024) : 0;
                    html += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-file-pdf text-danger me-2"></i>
                                <strong>${doc.nombre || doc.archivo_nombre}</strong>
                                <small class="text-muted ms-2">(${sizeKb} KB)</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="openPdfViewer(${doc.documento_id}, '${doc.nombre || doc.archivo_nombre}')">
                                    <i class="fas fa-eye"></i> Ver
                                </button>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
                docsList.innerHTML = html;
            } else {
                docsList.innerHTML = '<div class="alert alert-danger mb-0">Error al cargar documentos.</div>';
            }
        }

        async function openPdfViewer(docId, docName) {
            const modal = document.getElementById('pdfViewerModal');
            const iframe = document.getElementById('pdfFrame');
            const loading = document.getElementById('viewerLoading');
            const nameDisplay = document.getElementById('viewerDocName');

            // Store current doc info for download
            currentDocId = docId;
            currentDocName = docName;

            nameDisplay.textContent = docName;
            loading.style.display = 'block';
            iframe.src = 'about:blank';

            // Close the docs list modal
            $('#viewDocsModal').modal('hide');

            // Show viewer modal
            modal.classList.add('active');

            try {
                // Fetch document with auth headers
                const token = getToken();
                const response = await fetch(`${API_URL}/documentos/${docId}/view`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al cargar el documento');
                }

                const blob = await response.blob();

                // Revoke previous blob URL if exists
                if (currentBlobUrl) {
                    URL.revokeObjectURL(currentBlobUrl);
                }

                // Create new blob URL
                currentBlobUrl = URL.createObjectURL(blob);
                iframe.src = currentBlobUrl;

                iframe.onload = () => {
                    loading.style.display = 'none';
                };

            } catch (error) {
                console.error('Error:', error);
                loading.innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <p class="mt-2">Error al cargar el documento</p>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        function closePdfViewer() {
            const modal = document.getElementById('pdfViewerModal');
            const iframe = document.getElementById('pdfFrame');
            const loading = document.getElementById('viewerLoading');

            modal.classList.remove('active');

            // Reset after animation
            setTimeout(() => {
                iframe.src = 'about:blank';
                loading.style.display = 'block';
                loading.innerHTML = `
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Cargando documento...</p>
                `;

                // Revoke blob URL
                if (currentBlobUrl) {
                    URL.revokeObjectURL(currentBlobUrl);
                    currentBlobUrl = null;
                }
            }, 300);
        }

        async function downloadCurrentDoc() {
            if (!currentDocId || !currentDocName) return;

            try {
                const token = getToken();
                const response = await fetch(`${API_URL}/documentos/${currentDocId}/view`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Error al descargar');

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = currentDocName.endsWith('.pdf') ? currentDocName : `${currentDocName}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast("Descarga iniciada");
            } catch (error) {
                console.error('Error:', error);
                showToast("Error al descargar el archivo", "error");
            }
        }
    </script>
</body>

</html>